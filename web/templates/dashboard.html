<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnS Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/dashboard.css') }}">
    <script src="{{ url_for('static', path='/js/chart.umd.js') }}"></script>
    <!-- <link rel="stylesheet" href="../static/css/dashboard.css"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

    <style>
        /* MONTHLY GRAPH HEADER */
        main .stats-div .monthly #monthly-header{
            display: flex;
            justify-content: space-between;
            align-items: start;

            display: flex;
            flex-wrap: wrap;
        }

        main .stats-div .monthly #monthly-header h3{
            margin: 0;
            padding: 0;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
        }

        main .stats-div .monthly #monthly-header select{
            background: var(--second);
            color: var(--primary);
            border: none;
            border-radius: 5px;
            padding: 5px 12px;
            font-family: "DM Sans", sans-serif;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer; 
            transition: all 0.2s ease;
        }

        main .stats-div .monthly #monthly-header select:hover {
            background: var(--second-light);
        }

        main .stats-div .monthly #monthly-header select:focus {
            background: linear-gradient(133deg, var(--second) 60%, var(--second-light) 120%);
            color: var(--second-very-light);
        }

        main .stats-div .monthly .chart-div{
            width: 100%;
            height: clamp(220px, 38vh, 380px);
            overflow-x: auto;
            overflow-y: hidden;
            min-height: 0;
            flex: 1; 
            position: relative; 
        }

        main .stats-div .monthly .chart-div canvas{
            width: 100% !important; 
            height: auto !important;
            max-width: 100%; 
            display: block; 

            box-sizing: border-box;
        }

        /* top emergency count */
        main .stats-div .top #top-filters select,
        main .stats-div .top #top-filters input[type="date"] {
            background: var(--second);
        }

        main .stats-div .top #top-filters select:hover,
        main .stats-div .top #top-filters input[type="date"]:hover {
            background: var(--second-light);
        }

        /* ========================================= */
        /* FLOATING PRINT BUTTON */
        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(133deg, var(--second) 60%, var(--second-light) 120%);
            color: var(--primary);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(45, 51, 107, 0.3);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .print-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(45, 51, 107, 0.4);
            background: linear-gradient(133deg, var(--second-light) 60%, var(--second) 120%);
        }

        .print-button:active {
            transform: scale(0.95);
        }

        @media screen and (max-width: 768px) {
            .print-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }

            .print-button svg {
                width: 24px;
                height: 24px;
            }
        }
    </style>
    
    <style>
        /* overlay */
        .admin-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(1px);
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
            z-index: 1000;
        }
        .admin-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .admin-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            width: min(920px, 94vw);
            max-height: 85vh;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,.2);
            transform: translate(-50%, -45%);
            opacity: 0;
            pointer-events: none;
            transition: transform .2s ease, opacity .2s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;

            padding: 14px 18px;
        }
        .admin-modal.show {
            transform: translate(-50%, -50%);
            opacity: 1;
            pointer-events: auto;
        }

        /* overlay inside */
        .admin-modal h3, p{
            margin: 2px;
        }

        .admin-modal h3{
            color: var(--second);
        }

        .admin-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* border-bottom: 1px solid rgba(0,0,0,.06); */
        }
        .admin-modal-body {
            overflow: auto;
        }
        .admin-close {
            background: transparent;
            border: none;
            font-size: 22px;
            line-height: 1;
            cursor: pointer;
            color: #333;
        }

        /* add room button */
        .btn-manage {
            background: var(--second);
            color: var(--primary);
            border: none;
            border-radius: 5px;
            padding: 10px 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(45,51,107,0.2);
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .btn-manage:hover {
            background: var(--second-light);
        }
        
        /* TABLE */
        .device-section {
            padding-top: 20px;
            /* border-top: 2px solid var(--second-light); */
        }

        .device-section p.helper-text,
        .helper-text {
            color: #666;
            font-size: 0.88rem;
        }

        .device-table-container {
            /* overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.67);
            border-radius: 5px; */

            width: 100%;

            text-align: left;
            overflow-x: auto;

            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        .device-table {
            /* width: 100%;
            border-collapse: collapse;
            background: white;
            overflow: hidden; */
            min-width: auto;
            width: 100%;

            border-collapse: collapse;
            background: var(--primary);
            border-radius: 5px;
            overflow: hidden;
        }

        .device-table thead {
            background-color: #002c472a;
            padding: 7px 10px;
        }

        .device-table th {
            padding: 8px 10px;
            text-align: left;
        }

        .device-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            padding: 0;
        }

        .device-table tbody tr:last-child {
            border-bottom: none;
        }

        .device-table td {
            padding: 2px 10px;
            color: var(--text);
        }

        .device-table select {
            /* background: var(--second); */
            color: var(--second);
            border: none;
            border-radius: 5px;
            padding: 5px 0;
            font-family: "DM Sans", sans-serif;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .device-table select:focus {
            border-color: var(--second-light);
        }

        .no-devices-row {
            text-align: center;
            padding: 40px 20px !important;
            color: #999;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-rename {
            background: var(--second-light);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: "DM Sans", sans-serif;
            transition: background 0.2s;
        }

        .btn-rename:hover {
            background: var(--second);
        }

        .sensor-info {
            color: #666;
            font-size: 0.9rem;
        }

        .no-sensor {
            color: #999;
            font-style: italic;
        }

        .room-name-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-weight: 600;
            color: var(--text);
            padding-right: 5px;
        }

        .room-name-cell {
            color: var(--text);
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-action {
            background: transparent;
            border: 1px solid var(--second-light);
            color: var(--second);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.82rem;
            font-family: "DM Sans", sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-action:hover {
            background: var(--second);
            color: white;
            border-color: var(--second);
        }

        .btn-delete {
            border-color: var(--red);
            color: var(--red);
        }

        .btn-delete:hover {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }
        
        @media screen and (max-width: 768px) {
            .device-table th,
            .device-table td {
                padding: 10px 12px;
                font-size: 0.88rem;
            }

            .device-table select {
                font-size: 0.85rem;
            }

            .action-buttons {
                gap: 4px;
            }

            .btn-action {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }
    </style>
</body>
</html>
</head>
<body>
    <nav>
        <h1>Dashboard</h1>
        <div>
            <p id="current-date">00/00/00</p>
            <p class="time" id="current-time">00:00 AM</p>
        </div>
        <div class="admin-launch" style="margin:20px 0;">
            <button type="button" class="btn-manage" onclick="openAdminModal()">Manage Rooms & Devices</button>
        </div>
    </nav>

    <div id="admin-overlay" class="admin-overlay" onclick="closeAdminModal()"></div>

    <div id="admin-modal" class="admin-modal" role="dialog" aria-modal="true" aria-labelledby="admin-modal-title" onclick="event.stopPropagation()">
        <div class="admin-modal-header">
            <h3 id="helper-text" >Create New Room</h3>
            <!-- <h3 id="admin-modal-title" style="margin:0;">Manage Rooms & Sensors</h3> -->
            <button class="admin-close" onclick="closeAdminModal()" aria-label="Close">×</button>
        </div>
        <div class="admin-modal-body">
            <div>
                <p class="helper-text">Add a new room to monitor.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="new-room-name" placeholder="Enter room name (e.g., Kitchen)" 
                        style="flex:1; min-width:200px; padding:10px; border:2px solid var(--second-light); border-radius:5px; font-family: 'DM Sans', sans-serif;">
                    <button onclick="createRoom()" class="btn-manage">Add Room</button>
                </div>
            </div>

            <div class="device-section">
                <h3>Room & Sensor Management</h3>
                <p class="helper-text">Manage room names and assign sensors to each room.</p>
                <div class="device-table-container">
                    <table class="device-table">
                        <thead>
                            <tr>
                                <th>Room Name</th>
                                <th>Assigned Sensor</th>
                                <th>Sensor Actions</th>
                                <th>Room Actions</th>
                            </tr>
                        </thead>
                        <tbody id="device-table-body">
                            <tr>
                                <td colspan="4" class="no-devices-row">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
            </div>
        </div>
    </div>

    <main>
        <div class="rooms-div">
            <div class="room1 rooms room" data-room-id="1" onclick="selectRoom(1, this)">
                <svg class="logo" 
                    viewBox="0 0 512 512" fill="white" style="vertical-align: middle;">
                    <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                </svg>
                <div class="texts">
                    <h2 class="room-name">Room 1</h2>
                    <p onclick="renameRoom(this, event)">rename</p>
                </div>
            </div>
            <div class="room2 rooms room" data-room-id="2" onclick="selectRoom(2, this)">
                <svg class="logo" 
                    viewBox="0 0 512 512" fill="white" style="vertical-align: middle;">
                    <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                </svg>
                <div class="texts">
                    <h2 class="room-name">Room 2</h2>
                    <p onclick="renameRoom(this, event)">rename</p>
                </div>
            </div>
            <div class="room3 rooms room" data-room-id="3" onclick="selectRoom(3, this)">
                <svg class="logo" 
                    viewBox="0 0 512 512" fill="white" style="vertical-align: middle;">
                    <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                </svg>
                <div class="texts">
                    <h2 class="room-name">Room 3</h2>
                    <p onclick="renameRoom(this, event)">rename</p>
                </div>
            </div>
        </div>

        <div class="stats-div">
            <!-- Most Recent Emergency -->
            <div class="recent stats"> 
                <div>
                    <p>Most Recent Emergency</p>
                    <h2 id="recent-emergency"></h2>
                </div>
            </div>

            <!-- Monthly Detected Emergencies -->
            <div class="monthly stats">
                <div id="monthly-header">
                    <h3>Monthly Detected Emergencies</h3>
                    <select id="year-filter" onchange="updateMonthlyGraph()"></select>
                </div>
                <div class="chart-div">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Top Emergency Count -->
            <div class="top stats">
                <div id="top-header">
                    <h3>Top Emergency Count</h3>
                    <div id="top-filters">
                        <select id="top-range-filter" onchange="handleRangeChange()">
                            <option value="all">All Time</option>
                            <option value="this_year">This Year</option>
                            <option value="this_month">This Month</option>
                            <option value="last_7" selected>Last 7 Days</option>
                            <option value="last_30">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div class="date-inputs" id="custom-date-inputs">
                            <input type="date" id="start-date">
                            <span>to</span>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                </div>
                <div class="top-content">
                    <div class="pie-chart-container">
                        <canvas id="topChart"></canvas>
                        <div class="total-overlay">
                            <span class="total-label">Total</span>
                            <span class="total-value" id="total-emergencies">000</span>
                        </div>
                    </div>
                    <div class="room-stats">
                        <div class="room-stat" id="room-stat-1">
                            <span class="room-label">Room 1</span>
                            <span class="room-count">00</span>
                        </div>
                        <div class="room-stat" id="room-stat-2">
                            <span class="room-label">Room 2</span>
                            <span class="room-count">00</span>
                        </div>
                        <div class="room-stat" id="room-stat-3">
                            <span class="room-label">Room 3</span>
                            <span class="room-count">00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <aside>
        <header>
            <h2>Room #</h2>
            <!-- <i class="fa-solid fa-pen-to-square"></i> -->
            <i class="fa-solid fa-pen" onclick="renameCurrentRoom(event)">✎</i>
        </header>
        <p class="title">Alert History</p>
        <div class="table-div">
            <table>
                <tr>
                    <th>Action</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </table>
        </div>
        <div class="pagination-controls">
            <button onclick="prevPage('aside')" id="aside-prev">Prev</button>
            <span id="aside-page-info"></span>
            <button onclick="nextPage('aside')" id="aside-next">Next</button>
        </div>
    </aside>

    <!-- mobile overlay -->
    <div class="popup-overlay" onclick="closePopup()"></div>
    <div class="popup-aside">        
        <header>
            <div>
                <h2>Room #</h2>
                <i class="fa-solid fa-pen" onclick="renameCurrentRoom(event)">✎</i>
            </div>
            <span class="fa-solspand fa-times popup-close" onclick="closePopup()">x</i>
        </header>
        <p class="title">Alert History</p>
        <div class="table-div">
            <table>
                <tr>
                    <th>Action</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </table>
        </div>
        <div class="pagination-controls">
            <button onclick="prevPage('.popup-aside')" id="popup-prev">Prev</button>
            <span id="popup-page-info"></span>
            <button onclick="nextPage('.popup-aside')" id="popup-next">Next</button>
        </div>
    </div>

    <a href="/report" class="print-button" title="Generate Report">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="28" height="28">
            <path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zM432 248a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/>
        </svg>
    </a>

    <script>
        // REAL-TIME DATE AND TIME
        function updateDateTime() {
            const now = new Date();
            
            // Format date as MM/DD/YY
            const date = now.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            
            // Format time as HH:MM:SS AM/PM
            const time = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            document.getElementById('current-date').textContent = date;
            document.getElementById('current-time').textContent = time;
        }
        
        // Update immediately, then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // ====================================================================
        // ROOMS AND HISTORY        
        let roomData = {
            1: { name: "Room 1", history: [] },
            2: { name: "Room 2", history: [] },
            3: { name: "Room 3", history: [] }
        };

        let currentSelectedRoom = 1;
        const PAGE_SIZE = 9;
        let pageState = {
            'aside': 1,
            '.popup-aside': 1
        };

        // Fetch room data from API
        async function fetchRoomData() {
            try {
                const response = await fetch('/api/rooms');
                const rooms = await response.json();
                
                // Clear and rebuild roomData from API
                roomData = {};
                
                for (const [roomId, roomInfo] of Object.entries(rooms)) {
                    const id = parseInt(roomId);
                    roomData[id] = {
                        name: roomInfo.name,
                        history: []
                    };
                    
                    // Update room name in UI if the room card exists
                    const roomCard = document.querySelector(`.room[data-room-id="${id}"]`);
                    if (roomCard) {
                        const nameElement = roomCard.querySelector('.room-name');
                        if (nameElement) {
                            nameElement.textContent = roomInfo.name;
                        }
                    }
                }
                
                console.log('Room data loaded:', roomData);
            } catch (error) {
                console.error('Error fetching room data:', error);
            }
        }

        // Fetch history for a specific room
        async function fetchRoomHistory(roomId) {
            try {
                const response = await fetch(`/api/history/${roomId}`);
                const history = await response.json();
                roomData[roomId].history = history;
                return history;
            } catch (error) {
                console.error(`Error fetching history for room ${roomId}:`, error);
                return [];
            }
        }

        window.onload = async function() {
            await fetchRoomData();
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                await selectRoom(1, document.querySelector('.room1'));
            } else {
                currentSelectedRoom = 1;
            }
            updateAlertStates();
        };

        // select room
        async function selectRoom(roomNumber, roomElement) {
            currentSelectedRoom = roomNumber;
            pageState['aside'] = 1;
            pageState['.popup-aside'] = 1;
            
            // Fetch fresh history data
            await fetchRoomHistory(roomNumber);
            
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
                roomElement.classList.add('active-room');
                const roomName = roomData[roomNumber].name;
                document.querySelector('aside header h2').textContent = roomName;
                updateHistoryTable(roomNumber, 'aside');
            } else {
                const roomName = roomData[roomNumber].name;
                document.querySelector('.popup-aside header h2').textContent = roomName;
                updateHistoryTable(roomNumber, '.popup-aside');
                showPopup();
            }
        }

        function updateHistoryTable(roomNumber, container) {
            const tableBody = document.querySelector(`${container} table`);
            const history = roomData[roomNumber].history;
            const page = pageState[container];
            const start = (page - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pagedHistory = history.slice(start, end);

            // clear existing rows (keep header)
            while (tableBody.rows.length > 1) {
                tableBody.deleteRow(1);
            }

            pagedHistory.forEach(entry => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = entry.action;
                row.insertCell(1).textContent = entry.date;
                row.insertCell(2).textContent = entry.time;
            });

            // PAGINATION
            const totalPages = Math.ceil(history.length / PAGE_SIZE);
            const pageInfo = document.querySelector(
                container === 'aside' ? '#aside-page-info' : '#popup-page-info'
            );
            pageInfo.textContent = `${page} of ${totalPages}`;

            const prevBtn = document.querySelector(
                container === 'aside' ? '#aside-prev' : '#popup-prev'
            );
            const nextBtn = document.querySelector(
                container === 'aside' ? '#aside-next' : '#popup-next'
            );
            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages;
        }

        function prevPage(container) {
            if (pageState[container] > 1) {
                pageState[container]--;
                updateHistoryTable(currentSelectedRoom, container);
            }
        }

        function nextPage(container) {
            const history = roomData[currentSelectedRoom].history;
            const totalPages = Math.ceil(history.length / PAGE_SIZE);
            if (pageState[container] < totalPages) {
                pageState[container]++;
                updateHistoryTable(currentSelectedRoom, container);
            }
        }

        // POPUP
        function showPopup() {
            const overlay = document.querySelector('.popup-overlay');
            const popup = document.querySelector('.popup-aside');
            overlay.classList.add('show');
            popup.classList.add('show');
            const currentRoom = document.querySelector(`.room${currentSelectedRoom}`);
            if (currentRoom) {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
                currentRoom.classList.add('active-room');
            }
            document.body.style.overflow = 'hidden';
        }

        function closePopup() {
            const overlay = document.querySelector('.popup-overlay');
            const popup = document.querySelector('.popup-aside');
            overlay.classList.remove('show');
            popup.classList.remove('show');
            document.querySelectorAll('.rooms').forEach(room => {
                room.classList.remove('active-room');
            });
            document.body.style.overflow = 'auto';
        }

        function ensureActiveRoomState() {
            const activeRoom = document.querySelector(`.room${currentSelectedRoom}`);
            if (activeRoom && !activeRoom.classList.contains('active-room')) {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
                activeRoom.classList.add('active-room');
            }
        }

        // RENAME ROOM
        async function renameRoom(renameElement, event) {
            event.stopPropagation();
            const roomNameElement = renameElement.previousElementSibling;
            const currentName = roomNameElement.textContent;
            const roomDiv = renameElement.closest('.rooms');
            let roomNumber;
            if (roomDiv.classList.contains('room1')) {
                roomNumber = 1;
            } else if (roomDiv.classList.contains('room2')) {
                roomNumber = 2;
            } else if (roomDiv.classList.contains('room3')) {
                roomNumber = 3;
            }
            const newName = prompt(`Enter new name for ${currentName}:`, currentName);
            if (newName !== null && newName.trim() !== '') {
                const trimmedName = newName.trim();
                
                try {
                    const response = await fetch(`/api/rooms/${roomNumber}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ new_name: trimmedName })
                    });
                    
                    if (response.ok) {
                        roomNameElement.textContent = trimmedName;
                        roomData[roomNumber].name = trimmedName;
                        if (roomDiv.classList.contains('active-room')) {
                            const desktopHeader = document.querySelector('aside header h2');
                            const mobileHeader = document.querySelector('.popup-aside header h2');
                            if (desktopHeader) desktopHeader.textContent = trimmedName;
                            if (mobileHeader) mobileHeader.textContent = trimmedName;
                        }
                    } else {
                        alert('Failed to rename room');
                    }
                } catch (error) {
                    console.error('Error renaming room:', error);
                    alert('Error renaming room');
                }
            }
        }

        // RENAME ROOM USING PEN ICON
        async function renameCurrentRoom(event) {
            event.stopPropagation();
            
            const currentName = roomData[currentSelectedRoom].name;
            const newName = prompt(`Enter new name for ${currentName}:`, currentName);
            
            if (newName !== null && newName.trim() !== '') {
                const trimmedName = newName.trim();
                
                try {
                    const response = await fetch(`/api/rooms/${currentSelectedRoom}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ new_name: trimmedName })
                    });
                    
                    if (response.ok) {
                        // Update the room name in the data
                        roomData[currentSelectedRoom].name = trimmedName;
                        
                        // Update the room card name
                        document.querySelector(`.room${currentSelectedRoom} h2`).textContent = trimmedName;
                        
                        // Update the aside header
                        document.querySelector('aside header h2').textContent = trimmedName;
                        
                        // Update the popup header if it's open
                        const popupHeader = document.querySelector('.popup-aside header h2');
                        if (popupHeader) {
                            popupHeader.textContent = trimmedName;
                        }
                    } else {
                        alert('Failed to rename room');
                    }
                } catch (error) {
                    console.error('Error renaming room:', error);
                    alert('Error renaming room');
                }
            }
        }

        window.addEventListener('resize', function() {
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                closePopup();
                const roomName = roomData[currentSelectedRoom].name;
                document.querySelector('aside header h2').textContent = roomName;
                updateHistoryTable(currentSelectedRoom, 'aside');
                const currentRoom = document.querySelector(`.room${currentSelectedRoom}`);
                if (currentRoom) {
                    document.querySelectorAll('.rooms').forEach(room => {
                        room.classList.remove('active-room');
                    });
                    currentRoom.classList.add('active-room');
                }
            } else {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePopup();
            }
        });

        // ====================================================================
        // MOST RECENT EMERGENCY
        async function fetchRecentEmergency() {
            try {
                const response = await fetch('/api/recent_emergency');
                const data = await response.json();
                const elem = document.getElementById('recent-emergency');
                if (data && data.date && data.time) {
                    elem.textContent = `${data.date} @\u00A0${data.time.replace(' ', '\u00A0')}`;
                } else {
                    elem.textContent = "No emergencies yet";
                }
            } catch (error) {
                document.getElementById('recent-emergency').textContent = "Error loading";
            }
        }

        window.onload = async function() {
            await fetchRoomData();
            await fetchRecentEmergency();
            
            // Check all room statuses from history on page load
            await updateAllRoomStatusesFromHistory();
            
            // Connect WebSocket for real-time updates
            connectWebSocket();
            
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                await selectRoom(1, document.querySelector('.room1'));
            } else {
                currentSelectedRoom = 1;
            }
        };

        // ====================================================================
        // REAL-TIME ALERTS WITH WEBSOCKET
        let roomStatus = {1: 0, 2: 0, 3: 0};
        let websocket = null;
        let reconnectInterval = null;

        // Check the latest history status for each room
        async function updateRoomStatusFromHistory(roomId) {
            try {
                const response = await fetch(`/api/history/${roomId}`);
                const history = await response.json();
                
                if (history && history.length > 0) {
                    const latestAction = history[0].action; // Most recent record
                    
                    if (latestAction === "Emergency Detected") {
                        roomStatus[roomId] = 1; // Bell should animate
                        console.log(`Room ${roomId} latest: Emergency Detected - bell animating`);
                    } else if (latestAction === "Alert Acknowledged") {
                        roomStatus[roomId] = 0; // Bell should stop
                        console.log(`Room ${roomId} latest: Alert Acknowledged - bell stopped`);
                    }
                } else {
                    roomStatus[roomId] = 0; // No history = normal state
                }
                
                updateAlertStates();
            } catch (error) {
                console.error(`Error checking room ${roomId} status:`, error);
            }
        }

        // Update all room statuses from their history
        async function updateAllRoomStatusesFromHistory() {
            for (let roomId = 1; roomId <= 3; roomId++) {
                await updateRoomStatusFromHistory(roomId);
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('Attempting to connect to WebSocket:', wsUrl);
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('✓ WebSocket connected successfully!');
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                    
                    // Check history status when connected
                    updateAllRoomStatusesFromHistory();
                };
                
                websocket.onmessage = function(event) {
                    console.log('WebSocket message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Parsed data:', data);
                        
                        if (data.type === 'alert_update') {
                            console.log('Alert update received:', data);
                            
                            // Check the latest history to determine bell state
                            updateRoomStatusFromHistory(data.room_id);
                            
                            // Refresh recent emergency section
                            fetchRecentEmergency();
                            
                            // Refresh history for the affected room
                            fetchRoomHistory(data.room_id).then(() => {
                                // Update the table if we're currently viewing this room
                                if (currentSelectedRoom === data.room_id) {
                                    const aside = document.querySelector('aside');
                                    const isDesktop = window.getComputedStyle(aside).display !== 'none';
                                    if (isDesktop) {
                                        updateHistoryTable(data.room_id, 'aside');
                                    } else {
                                        const popup = document.querySelector('.popup-aside');
                                        if (popup.classList.contains('show')) {
                                            updateHistoryTable(data.room_id, '.popup-aside');
                                        }
                                    }
                                }
                            });
                            
                            // Update graphs
                            updateMonthlyGraph();
                            updateTopChart();
                        }
                        else if (data.type === 'room_renamed') {
                            console.log('Room renamed:', data);
                            // Update room name in UI
                            const roomCard = document.querySelector(`.room[data-room-id="${data.room_id}"]`);
                            if (roomCard) {
                                const nameElement = roomCard.querySelector('.room-name');
                                if (nameElement) {
                                    nameElement.textContent = data.new_name;
                                }
                            }
                            
                            // Update in roomData
                            if (roomData[data.room_id]) {
                                roomData[data.room_id].name = data.new_name;
                            }
                            
                            // Update aside headers if this is the current room
                            if (currentSelectedRoom === data.room_id) {
                                document.querySelector('aside header h2').textContent = data.new_name;
                                const popupHeader = document.querySelector('.popup-aside header h2');
                                if (popupHeader) {
                                    popupHeader.textContent = data.new_name;
                                }
                            }
                            
                            // Update top chart room labels
                            updateTopChart();
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket disconnected. Attempting to reconnect...');
                    websocket = null;
                    
                    // Attempt to reconnect every 3 seconds
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            console.log('Reconnecting...');
                            connectWebSocket();
                        }, 3000);
                    }
                };
                
            } catch (error) {
                console.error('Error creating WebSocket:', error);
            }
        }

        function updateAlertStates() {
            console.log('Updating alert states with:', roomStatus);
            
            // Update each room card
            for (let roomId in roomStatus) {
                const roomCard = document.querySelector(`.room[data-room-id="${roomId}"]`);
                if (roomCard) {
                    const statusValue = roomStatus[roomId];
                    console.log(`Room ${roomId} card found, status: ${statusValue}`);
                    
                    if (statusValue === 1) {
                        // Latest history is "Emergency Detected" - bell should blink
                        roomCard.classList.add('alert-active');
                        console.log(`Room ${roomId} set to alert-active - bell blinking`);
                    } else {
                        // Latest history is "Alert Acknowledged" or no history - stop blinking
                        roomCard.classList.remove('alert-active');
                        console.log(`Room ${roomId} alert cleared - bell stopped blinking`);
                    }
                } else {
                    console.warn(`Room card not found for room ${roomId}`);
                }
            }
        }

        // Initialize WebSocket connection when page loads
        console.log('Initializing WebSocket connection...');
        connectWebSocket();
    </script>

    <!-- GRAPHS -->
    <script>
        // MONTHLY DETECTED EMERGENCIES
        let monthlyChart = null;

        // Aspect ratio helper based on screen width
        function getLineChartAspectRatio() {
            const w = window.innerWidth;
            if (w >= 1440) return 1.5;  
            if (w >= 1358) return 1.3;  
            if (w >= 1274) return 1.8;  
            if (w >= 1128) return 1.1;  
            if (w >= 1024) return .9;  
            if (w >= 900) return .7;  
            if (w >= 769)  return 1.8;  
            if (w >= 735)  return 1.4;   
            if (w >= 600)  return 1.1;   
            if (w >= 520)  return 1.1;   
            if (w >= 441)  return .7;   
            if (w >= 320)  return 1.5;   
            return 1.1;                 
        }

        let monthlyResizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(monthlyResizeTimer);
            monthlyResizeTimer = setTimeout(() => {
                if (monthlyChart) {
                    monthlyChart.options.aspectRatio = getLineChartAspectRatio();
                    monthlyChart.resize();
                    monthlyChart.update();
                }
            }, 150);
        });

        async function initializeYearFilter() {
            try {
                const response = await fetch('/api/available_years');
                const years = await response.json();
                
                const yearFilter = document.getElementById('year-filter');
                yearFilter.innerHTML = '';
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
                
                // Load data for the first year
                if (years.length > 0) {
                    await updateMonthlyGraph();
                }
            } catch (error) {
                console.error('Error loading years:', error);
            }
        }

        async function updateMonthlyGraph() {
            const yearFilter = document.getElementById('year-filter');
            const selectedYear = yearFilter.value;
            
            try {
                const response = await fetch(`/api/monthly_emergencies/${selectedYear}`);
                const data = await response.json();
                
                console.log('Raw monthly data received:', data);
                
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // The data should already be an array of 12 values [count_jan, count_feb, ..., count_dec]
                let values;
                if (Array.isArray(data)) {
                    values = data;
                } else {
                    // Fallback: convert object to array
                    values = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    for (const [month, count] of Object.entries(data)) {
                        const monthIndex = parseInt(month) - 1; // month is 1-12, array is 0-11
                        if (monthIndex >= 0 && monthIndex < 12) {
                            values[monthIndex] = count;
                        }
                    }
                }
                
                console.log('Processed values for chart:', values);
                console.log('October (index 9) value:', values[9]);
                
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                
                monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Monthly Detected Emergencies',
                            data: values,
                            borderColor: '#015382', //second-light
                            backgroundColor: 'rgba(136, 143, 167, 0.20)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#002C47', //second
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: getLineChartAspectRatio(),
                        plugins: {
                            filler: {
                                propagate: false
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#002C47', //second
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#015382', //second-light
                                borderWidth: 1,
                                displayColors: false,
                                intersect: false,
                                mode: 'index',
                                callbacks: {
                                    label: function(context) {
                                        return `Emergencies: ${context.parsed.y}`;
                                    },
                                    title: function(context) {
                                        return `${context[0].label} ${selectedYear}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    color: '#666',
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#666'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error updating monthly graph:', error);
            }
        }

        // TOP EMERGENCY COUNT PIE CHART
        let topChart = null;

        function handleRangeChange() {
            const rangeFilter = document.getElementById('top-range-filter');
            const customInputs = document.getElementById('custom-date-inputs');
            
            if (rangeFilter.value === 'custom') {
                customInputs.classList.add('show');
                // Set default dates
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                document.getElementById('end-date').valueAsDate = today;
                document.getElementById('start-date').valueAsDate = thirtyDaysAgo;
                
                // Update chart with default custom range
                applyCustomRange();
            } else {
                customInputs.classList.remove('show');
                updateTopChart();
            }
        }

        async function applyCustomRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            await updateTopChart();
        }

        // Add event listeners for Enter key on date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const startDate = document.getElementById('start-date');
            const endDate = document.getElementById('end-date');
            
            if (startDate && endDate) {
                startDate.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyCustomRange();
                });
                endDate.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyCustomRange();
                });
                
                // Auto-apply when both dates are selected
                endDate.addEventListener('change', function() {
                    if (startDate.value && endDate.value) {
                        applyCustomRange();
                    }
                });
            }
        });

        async function updateTopChart() {
            const rangeFilter = document.getElementById('top-range-filter');
            const selectedRange = rangeFilter.value;
            
            let url = '/api/top_emergencies';
            
            if (selectedRange === 'custom') {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                if (!startDate || !endDate) {
                    console.warn('Custom range selected but dates not set');
                    return;
                }
                
                url += `?range=custom&start_date=${startDate}&end_date=${endDate}`;
            } else if (selectedRange !== 'all') {
                url += `?range=${selectedRange}`;
            }
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Update total
                document.getElementById('total-emergencies').textContent = 
                    data.total.toString().padStart(3, '0');
                
                // Ensure all 3 rooms are displayed with current names
                for (let roomId = 1; roomId <= 3; roomId++) {
                    const statElement = document.getElementById(`room-stat-${roomId}`);
                    if (statElement) {
                        const roomInfo = data.rooms[roomId] || { name: roomData[roomId].name, count: 0 };
                        statElement.querySelector('.room-label').textContent = roomInfo.name;
                        statElement.querySelector('.room-count').textContent = 
                            roomInfo.count.toString().padStart(2, '0');
                    }
                }
                
                // Create pie chart (only with rooms that have data)
                const ctx = document.getElementById('topChart').getContext('2d');
                
                if (topChart) {
                    topChart.destroy();
                }
                
                const sortedRooms = Object.entries(data.rooms)
                    .filter(([_, roomData]) => roomData.count > 0)
                    .sort((a, b) => b[1].count - a[1].count);
                
                const labels = sortedRooms.map(([_, roomData]) => roomData.name);
                const values = sortedRooms.map(([_, roomData]) => roomData.count);
                const colors = ['#015382', '#2d8ec2', '#002C47']; //second-light, second-very-light, --
                
                topChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, values.length),
                            borderWidth: 0,
                            cutout: '50%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#002C47', //second
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#015382', //second-light
                                borderWidth: 1,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 
                                            ? ((context.parsed / total) * 100).toFixed(1) 
                                            : 0;
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: 0
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating top chart:', error);
            }
        }
        // Initialize both charts on page load
        window.addEventListener('load', async function() {
            await initializeYearFilter();
            await updateTopChart(); 
        });
    </script>

    <!-- OVERLAY -->
    <script>
        function openAdminModal() {
            const overlay = document.getElementById('admin-overlay');
            const modal = document.getElementById('admin-modal');
            overlay.classList.add('show');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            // Refresh data when opened
            try { loadDevices(); } catch(e) {}
            // Focus input
            const input = document.getElementById('new-room-name');
            if (input) { setTimeout(() => input.focus(), 50); }
        }

        function closeAdminModal() {
            const overlay = document.getElementById('admin-overlay');
            const modal = document.getElementById('admin-modal');
            overlay.classList.remove('show');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close admin modal on ESC as well
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAdminModal();
            }
        });
                
        async function createRoom() {
            const nameEl = document.getElementById('new-room-name');
            const room_name = nameEl.value.trim();
            if (!room_name) { alert("Enter room name"); return; }
            try {
                const r = await fetch('/api/rooms', {
                method: 'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({room_name})
                });
                if (!r.ok) throw new Error(await r.text());
                nameEl.value = '';
                await fetchRoomData();
                updateMonthlyGraph();
                updateTopChart();
                loadDevices(); // refresh
            } catch(e){ console.error(e); alert("Failed to add room"); }
        }

        async function loadDevices() {
            try {
                const [devicesResp, roomsResp] = await Promise.all([
                    fetch('/api/devices'),
                    fetch('/api/rooms')
                ]);
                
                const devices = await devicesResp.json();
                const rooms = await roomsResp.json();
                
                const tbody = document.getElementById('device-table-body');
                
                // Create a map of room_id -> device info
                const roomToDevice = {};
                devices.forEach(d => {
                    if (d.room_id !== 0) {
                        roomToDevice[d.room_id] = d.device_id;
                    }
                });
                
                // Create available sensors list (devices not assigned or with room_id = 0)
                const availableDevices = devices.filter(d => d.room_id === 0);
                
                // Sort room IDs
                const sortedRoomIds = Object.keys(rooms).sort((a, b) => parseInt(a) - parseInt(b));
                
                if (sortedRoomIds.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-devices-row">No rooms available. Create a room first.</td></tr>';
                    return;
                }
                
                let sensorCounter = 1;
                const deviceLabels = {}; // Map device_id -> "Sensor #X"
                
                // First pass: label all devices
                devices.forEach(d => {
                    deviceLabels[d.device_id] = `Sensor #${sensorCounter++}`;
                });
                
                tbody.innerHTML = sortedRoomIds.map(roomId => {
                    const room = rooms[roomId];
                    const assignedDeviceId = roomToDevice[roomId];
                    const sensorLabel = assignedDeviceId ? deviceLabels[assignedDeviceId] : null;
                    
                    return `
                        <tr>
                            <td class="room-name-cell">${room.name}</td>
                            <td class="sensor-info">
                                ${sensorLabel ? sensorLabel : '<span class="no-sensor">No sensor assigned</span>'}
                            </td>
                            <td>
                                <select data-room="${roomId}" onchange="assignSensorToRoom(this)">
                                    <option value="" style="color: #015382;">Select Sensor</option>
                                    ${assignedDeviceId ? `<option value="${assignedDeviceId}" selected>${deviceLabels[assignedDeviceId]}</option>` : ''}
                                    ${availableDevices.map(d => 
                                        `<option value="${d.device_id}">${deviceLabels[d.device_id]}</option>`
                                    ).join('')}
                                    ${assignedDeviceId ? '<option value="unassign">Remove Sensor</option>' : ''}
                                </select>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action" onclick="renameRoomFromTable(${roomId}, '${room.name.replace(/'/g, "\\'")}')">
                                        Rename
                                    </button>
                                    <button class="btn-action btn-delete" onclick="deleteRoom(${roomId}, '${room.name.replace(/'/g, "\\'")}')">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('Failed to load devices:', err);
                document.getElementById('device-table-body').innerHTML = 
                    '<tr><td colspan="4" class="no-devices-row">Unable to load data. Please refresh.</td></tr>';
            }
        }

        async function deleteRoom(roomId, roomName) {
            const confirmDelete = confirm(`Are you sure you want to delete "${roomName}"?\n\nThis will remove all emergency history for this room and cannot be undone.`);
            
            if (!confirmDelete) {
                return;
            }

            try {
                const response = await fetch(`/api/rooms/${roomId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove from roomData
                    delete roomData[roomId];
                    
                    // Remove room card if exists
                    const roomCard = document.querySelector(`.room[data-room-id="${roomId}"]`);
                    if (roomCard) {
                        roomCard.remove();
                    }
                    
                    // If this was the selected room, switch to another room
                    if (currentSelectedRoom === roomId) {
                        const remainingRooms = Object.keys(roomData).map(id => parseInt(id));
                        if (remainingRooms.length > 0) {
                            const newRoomId = remainingRooms[0];
                            const newRoomCard = document.querySelector(`.room[data-room-id="${newRoomId}"]`);
                            if (newRoomCard) {
                                await selectRoom(newRoomId, newRoomCard);
                            }
                        }
                    }
                    
                    // Refresh the table
                    await loadDevices();
                    
                    // Update graphs
                    updateMonthlyGraph();
                    updateTopChart();
                    
                    alert(`"${roomName}" has been deleted successfully.`);
                } else {
                    const error = await response.json();
                    alert(`Failed to delete room: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room. Please try again.');
            }
        }

        async function assignSensorToRoom(sel) {
            const roomId = parseInt(sel.getAttribute('data-room'));
            const deviceId = sel.value;
            
            if (!deviceId) {
                alert('Please select a sensor.');
                await loadDevices();
                return;
            }
            
            if (deviceId === 'unassign') {
                // Find the device currently assigned to this room and unassign it
                try {
                    const devicesResp = await fetch('/api/devices');
                    const devices = await devicesResp.json();
                    const currentDevice = devices.find(d => d.room_id === roomId);
                    
                    if (currentDevice) {
                        const resp = await fetch(`/api/devices/${encodeURIComponent(currentDevice.device_id)}/assign_room`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({room_id: 0}) // Unassign
                        });
                        
                        if (resp.ok) {
                            await loadDevices();
                            updateTopChart();
                        } else {
                            alert('Failed to remove sensor.');
                            await loadDevices();
                        }
                    }
                } catch (err) {
                    console.error('Error removing sensor:', err);
                    alert('Error removing sensor.');
                    await loadDevices();
                }
                return;
            }

            try {
                const resp = await fetch(`/api/devices/${encodeURIComponent(deviceId)}/assign_room`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({room_id: roomId})
                });
                
                if (resp.ok) {
                    await loadDevices();
                    updateTopChart();
                } else {
                    alert('Failed to assign sensor.');
                    await loadDevices();
                }
            } catch (err) {
                console.error('Error assigning sensor:', err);
                alert('Error assigning sensor.');
                await loadDevices();
            }
        }

        async function renameRoomFromTable(roomId, currentName) {
            const newName = prompt(`Enter new name for ${currentName}:`, currentName);
            
            if (newName !== null && newName.trim() !== '' && newName.trim() !== currentName) {
                const trimmedName = newName.trim();
                
                try {
                    const response = await fetch(`/api/rooms/${roomId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ new_name: trimmedName })
                    });
                    
                    if (response.ok) {
                        // Update roomData
                        roomData[roomId].name = trimmedName;
                        
                        // Update room card if exists
                        const roomCard = document.querySelector(`.room[data-room-id="${roomId}"]`);
                        if (roomCard) {
                            roomCard.querySelector('.room-name').textContent = trimmedName;
                        }
                        
                        // Update aside if this is current room
                        if (currentSelectedRoom === roomId) {
                            document.querySelector('aside header h2').textContent = trimmedName;
                            const popupHeader = document.querySelector('.popup-aside header h2');
                            if (popupHeader) popupHeader.textContent = trimmedName;
                        }
                        
                        // Refresh table
                        await loadDevices();
                        updateTopChart();
                    } else {
                        alert('Failed to rename room.');
                    }
                } catch (error) {
                    console.error('Error renaming room:', error);
                    alert('Error renaming room.');
                }
            }
        }

        function buildRoomOptions(current) {
            let opts = '';
            
            // Sort room IDs numerically
            const sortedRoomIds = Object.keys(roomData).sort((a, b) => parseInt(a) - parseInt(b));
            
            // Add all room options
            for (const id of sortedRoomIds) {
                const sel = parseInt(id) === parseInt(current) ? 'selected' : '';
                opts += `<option value="${id}" ${sel}>${roomData[id].name}</option>`;
            }
            
            return opts;
        }

        async function assignDeviceFromTable(sel) {
            const deviceId = sel.getAttribute('data-device');
            const roomId = parseInt(sel.value);
            
            if (roomId === 0) {
                alert('Please select a room.');
                await loadDevices();
                return;
            }

            try {
                const resp = await fetch(`/api/devices/${encodeURIComponent(deviceId)}/assign_room`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({room_id: roomId})
                });
                
                if (resp.ok) {
                    await loadDevices();
                    updateTopChart();
                } else {
                    alert('Failed to assign sensor.');
                    await loadDevices();
                }
            } catch (err) {
                console.error('Error assigning device:', err);
                alert('Error assigning sensor.');
                await loadDevices();
            }
        }

        setInterval(loadDevices, 10000); // refresh list
            window.addEventListener('load', () => {
            setTimeout(loadDevices, 1500);
        });
    </script>
</body>
</html>