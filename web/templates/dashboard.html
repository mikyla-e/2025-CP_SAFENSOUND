<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnS Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/dashboard.css') }}">
    <script src="{{ url_for('static', path='/js/chart.umd.js') }}"></script>
    <!-- <link rel="stylesheet" href="../static/css/dashboard.css"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

    <style>
        /* MONTHLY GRAPH HEADER */
        main .stats-div .monthly #monthly-header{
            display: flex;
            justify-content: space-between;
            align-items: start;

            display: flex;
            flex-wrap: wrap;
        }

        main .stats-div .monthly #monthly-header h3{
            margin: 0;
            padding: 0;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
        }

        main .stats-div .monthly #monthly-header select{
            background: var(--second);
            color: var(--primary);
            border: none;
            border-radius: 5px;
            padding: 5px 12px;
            font-family: "DM Sans", sans-serif;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer; 
            transition: all 0.2s ease;
        }

        main .stats-div .monthly #monthly-header select:hover {
            background: var(--second-light);
        }

        main .stats-div .monthly #monthly-header select:focus {
            background: linear-gradient(133deg, var(--second) 60%, var(--second-light) 120%);
            color: var(--second-very-light);
        }

        main .stats-div .monthly .chart-div{
            width: 100%;
            height: clamp(220px, 38vh, 380px);
            overflow-x: auto;
            overflow-y: hidden;
            min-height: 0;
            flex: 1; 
            position: relative; 
        }

        main .stats-div .monthly .chart-div canvas{
            width: 100% !important; 
            height: auto !important;
            max-width: 100%; 
            display: block; 

            box-sizing: border-box;
        }

        /* top emergency count */
        main .stats-div .top #top-filters select,
        main .stats-div .top #top-filters input[type="date"] {
            background: var(--second);
        }

        main .stats-div .top #top-filters select:hover,
        main .stats-div .top #top-filters input[type="date"]:hover {
            background: var(--second-light);
        }

        main .stats-div .top .room-stats {
            overflow-y: auto;
            height: 60%;
            padding-right: 15px;
        }
        
        @media screen and (max-width: 768px) {
            .time {
                display: none;
            }
        }

        @media screen and (max-width: 440px) {
            nav {
                flex-wrap: wrap;
                padding: 20px clamp(3.5vw, 4vw, 5vw)  10px clamp(3.5vw, 4vw, 5vw);
                justify-content: space-between;
                gap: 8px;
            }

            /* Back button and Dashboard on the left */
            nav .backNdashboard {
                flex: 1;
                order: 1;
            }

            /* Manage button on the right */
            nav .admin-launch {
                margin: 0 !important;
                flex: 0 0 auto;
                order: 2;
            }
            
            nav .admin-launch .btn-manage {
                padding: 8px 12px;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            nav .admin-launch .btn-manage span{
                display: none;
            }

            /* Date and time below - full width with space between */
            nav > div:not(.backNdashboard):not(.admin-launch) {
                width: 100%;
                flex-basis: 100%;
                order: 3;
                justify-content: space-between; 
                margin-top: 5px;
                display: flex;
                gap: 10px;
            }

            nav h1 {
                margin: 0;
                font-size: 1.3rem;
            }

            .time {
                display: inline;
            }
        }
    </style>
    
    <style>
        /* MANGE ROOMS AND DEVICES OVERLAY */
        .admin-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(1px);
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
            z-index: 1000;
        }
        .admin-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .admin-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            width: min(920px, 94vw);
            max-height: 85vh;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,.2);
            transform: translate(-50%, -45%);
            opacity: 0;
            pointer-events: none;
            transition: transform .2s ease, opacity .2s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;

            padding: 14px 18px;
        }
        .admin-modal.show {
            transform: translate(-50%, -50%);
            opacity: 1;
            pointer-events: auto;
        }

        /* overlay inside */
        .admin-modal h3, p{
            margin: 2px;
        }

        .admin-modal h3{
            color: var(--second);
        }

        .admin-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .admin-modal-body {
            overflow: auto;
        }
        .admin-close {
            background: transparent;
            border: none;
            font-size: 22px;
            line-height: 1;
            cursor: pointer;
            color: #333;
        }

        /* add room button */
        .btn-manage {
            background: var(--second);
            color: var(--primary);
            border: none;
            border-radius: 5px;
            padding: 10px 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(45,51,107,0.2);
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .btn-manage:hover {
            background: var(--second-light);
        }

        /* logout button */
        .btn-logout {
            background: var(--red); 
            color: var(--primary);
            border: none;
            border-radius: 5px;
            padding: 7.5px 16px;
            cursor: pointer;
            /* box-shadow: 0 2px 8px rgba(45,51,107,0.2); */
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .btn-logout:hover {
            background: #ee3e47;
        }

        /* ROOM AND DEVICES TABLE */
        .device-section {
            padding-top: 20px;
        }

        .device-section p.helper-text,
        .helper-text {
            color: #666;
            font-size: 0.88rem;
        }

        .device-table-container {
            width: 100%;

            text-align: left;
            overflow-x: auto;

            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        .device-table {
            min-width: auto;
            width: 100%;

            border-collapse: collapse;
            background: var(--primary);
            border-radius: 5px;
            overflow: hidden;
        }

        .device-table thead {
            background-color: #002c472a;
            padding: 7px 10px;
        }

        .device-table th {
            padding: 8px 10px;
            text-align: left;
        }

        .device-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            padding: 0;
        }

        .device-table tbody tr:last-child {
            border-bottom: none;
        }

        .device-table td {
            padding: 2px 10px;
            color: var(--text);
        }

        .device-table select {
            color: var(--second);
            border: none;
            border-radius: 5px;
            padding: 5px 0;
            font-family: "DM Sans", sans-serif;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .device-table select:focus {
            border-color: var(--second-light);
        }

        .no-devices-row {
            text-align: center;
            padding: 40px 20px !important;
            color: #999;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-rename {
            background: var(--second-light);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: "DM Sans", sans-serif;
            transition: background 0.2s;
        }

        .btn-rename:hover {
            background: var(--second);
        }

        .sensor-info {
            color: #666;
            font-size: 0.9rem;
        }

        .no-sensor {
            color: #999;
            font-style: italic;
        }

        .room-name-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-weight: 600;
            color: var(--text);
            padding-right: 5px;
        }

        .room-name-cell {
            color: var(--text);
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-action {
            background: transparent;
            border: 1px solid var(--second-light);
            color: var(--second);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.82rem;
            font-family: "DM Sans", sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-action:hover {
            background: var(--second);
            color: white;
            border-color: var(--second);
        }

        .btn-delete {
            border-color: var(--red);
            color: var(--red);
        }

        .btn-delete:hover {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }
        
        @media screen and (max-width: 768px) {
            .device-table th,
            .device-table td {
                padding: 10px 12px;
                font-size: 0.88rem;
            }

            .device-table select {
                font-size: 0.85rem;
            }

            .action-buttons {
                gap: 4px;
            }

            .btn-action {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }

        /* ========================================= */
        /* ========================================= */
        /* FLOATING PRINT BUTTON */
        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(133deg, var(--second) 60%, var(--second-light) 120%);
            color: var(--primary);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(45, 51, 107, 0.3);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .print-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(45, 51, 107, 0.4);
            background: linear-gradient(133deg, var(--second-light) 60%, var(--second) 120%);
        }

        .print-button:active {
            transform: scale(0.95);
        }

        @media screen and (max-width: 768px) {
            .print-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }

            .print-button svg {
                width: 24px;
                height: 24px;
            }
        }

        /* ================================ */
        /* ================================ */
        /* ROOMS CAROUSEL */
        /* div containing rooms */
        main .rooms-div{
            position: relative;
        }

        /* Navigation arrows */
        .carousel-prev,
        .carousel-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: var(--second);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-prev:hover,
        .carousel-next:hover {
            opacity: 1;
            background: var(--second-light);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-prev {
            left: 0;
        }

        .carousel-next {
            right: 0;
        }

        .carousel-prev:disabled,
        .carousel-next:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #ccc;
        }

        /* Rooms container wrapper */
        .rooms-container {
            display: flex;
            gap: 15px;
            transition: transform 0.4s ease;
            width: 100%;
            box-sizing: border-box;
            flex-direction: row;
            justify-content: center;
        }

        @keyframes newEmergency {
            0% {
                background-color: rgba(181, 46, 52, 0.3)
            }
            50% {
                background-color: rgba(181, 46, 52, 0.15)
            }
            100% {
                background-color: rgba(181, 46, 52, 0.3)
            }
        }

        @keyframes newAlarming {
            0% {
                background-color: rgba(245, 158, 11, 0.3)
            }
            50% {
                background-color: rgba(245, 158, 11, 0.15)
            }
            100% {
                background-color: rgba(245, 158, 11, 0.3)
            }
        }

        .history-row.new-emergency {
            animation: newEmergency 3s ease;
            border-left: 3px solid var(--red);
        }

        .history-row.new-alarming {
            animation: newAlarming 3s ease;
            border-left: 3px solid #F59E0B;
        }

        .history-row.acknowledged-highlight{
            animation: none;
            background-color: #10B9811a; /* Green with low opacity */
            border-left: 3px solid #10B981; /* Green border */
            transition: background-color 5s ease-out, border-left-color 5s ease-out
        }

        .history-row.fade-highlight {
            animation: none;
            background-color: transparent;
            border-left: 3px solid transparent;
            transition: all 0.5s ease-out;
        }

        .history-row.has_audio {
            cursor: pointer;
            transition : background-color 0.2s;
        }

        .history-row.has_audio:hover {
            background-color: rgba(1, 83, 130, 0.08);
        }

        .action-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .play-icon {
            width: 14px;
            height: 14px;
            fill: var(--second);
            flex-shrink: 0;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
        }

        .history-row.has-audio:hover .play-icon {
            opacity: 1;
            transform: scale(1.1);
        }
/* 
        .action-text {
            flex: 1;
        } */

        .action-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .action-icon svg {
            flex-shrink: 0;
        }

        .emergency, .alarming{
            display: inline-flex;
            align-items: center;
        }

        .emergency svg {
            width: 22px;
            height: 22px;
            fill: var(--red);
        }

        .alarming svg {
            width: 22px;
            height: 22px;
            fill: #F59E0B; /* Orange */
        }

        .action-icon.acknowledged svg {
            width: 22px;
            height: 22px;
            fill: #10B981; /* Green */
        }

        .action-icon .action-label {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .action-icon.emergency .action-label {
            color: var(--red);
        }

        .action-icon.alarming .action-label {
            color: #F59E0B;
        }

        .action-icon.acknowledged .action-label {
            color: #10B981;
        }

        /* Sound type styling */
        .sound-type-label {
            color: var(--second-light);
            font-size: 0.8rem;
            margin-left: 4px;
        }

        /* Audio Modal */
        .audio-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .audio-modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }

        .audio-modal-overlay.show .audio-modal {
            transform: scale(1);
        }

        .audio-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .audio-modal-header h3 {
            margin: 0;
            color: var(--second);
            font-size: 1.1rem;
        }

        .audio-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

        .audio-modal-close:hover {
            color: #333;
        }

        .audio-modal-body {
            text-align: center;
        }

        .audio-modal-info {
            margin-bottom: 16px;
            color: #666;
            font-size: 0.9rem;
        }

        .audio-modal-info p {
            margin: 4px 0;
        }

        .audio-modal audio {
            width: 100%;
            margin-top: 10px;
        }

        .audio-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            justify-content: center;
        }

        .btn-audio-action {
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-family: "DM Sans", sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-download-audio {
            background: var(--second);
            color: white;
            text-decoration: none;
            display: inline-block;
        }

        .btn-download-audio:hover {
            background: var(--second-light);
        }

        .btn-close-audio {
            background: #e9ecef;
            color: #333;
        }

        .btn-close-audio:hover {
            background: #dee2e6;
        }
        
    </style>
    
</body>
</html>
</head>
<body>
    <nav>
        <div class="backNdashboard" style="display: flex; align-items: center; gap: 15px;">
            <a href="/" style="text-decoration: none; color: var(--second); display: flex; align-items: center; font-size: 1.2rem; transition: color 0.3s;" title="Back to Homepage">
                ←
            </a>
            <h1>Dashboard</h1>
        </div>
        <div>
            <p id="current-date">00/00/00</p>
            <p class="time" id="current-time">00:00 AM</p>
        </div>
        <div class="admin-launch" style="margin:20px 0; display: flex; gap: 10px; align-items: center;">
            <!-- <span style="color: var(--text-light); font-size: 0.9rem;">{{ username }}</span> -->
            <button type="button" class="btn-manage" onclick="openAdminModal()"><span>Manage </span>Rooms & Devices</button>
            <a href="/logout" class="btn-logout" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="white" style="width: 16px; height: 16px; vertical-align: middle;">
                    <path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/>
                </svg>
            </a>
        </div>
    </nav>

    <div id="admin-overlay" class="admin-overlay" onclick="closeAdminModal()"></div>

    <div id="admin-modal" class="admin-modal" role="dialog" aria-modal="true" aria-labelledby="admin-modal-title" onclick="event.stopPropagation()">
        <div class="admin-modal-header">
            <h3 id="helper-text" >Create New Room</h3>
            <!-- <h3 id="admin-modal-title" style="margin:0;">Manage Rooms & Sensors</h3> -->
            <button class="admin-close" onclick="closeAdminModal()" aria-label="Close">×</button>
        </div>
        <div class="admin-modal-body">
            <div>
                <p class="helper-text">Add a new room to monitor.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="new-room-name" placeholder="Enter room name (e.g., Kitchen)" 
                        style="flex:1; min-width:200px; padding:10px; border:2px solid var(--second-light); border-radius:5px; font-family: 'DM Sans', sans-serif;">
                    <button onclick="createRoom()" class="btn-manage">Add Room</button>
                </div>
            </div>

            <div class="device-section">
                <h3>Room & Sensor Management</h3>
                <p class="helper-text">Manage room names and assign sensors to each room.</p>
                <div class="device-table-container">
                    <table class="device-table">
                        <thead>
                            <tr>
                                <th>Room Name</th>
                                <th>Assigned Sensor</th>
                                <th>Sensor Actions</th>
                                <th>Room Actions</th>
                            </tr>
                        </thead>
                        <tbody id="device-table-body">
                            <tr>
                                <td colspan="4" class="no-devices-row">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
            </div>

            <!-- <div class="device-section">
                <h3>System Control</h3>
                <p class="helper-text">Remotely shutdown system components.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                    <button onclick="shutdownSystem('all')" class="btn-action btn-delete">
                        Shutdown
                    </button>
                </div>
            </div> -->
        </div>
    </div>

    <main>
        <!-- rooms -->
        <div class="rooms-div">
            <div class="room1 rooms room" data-room-id="1" onclick="selectRoom(1, this)">
                <svg class="logo" 
                    viewBox="0 0 512 512" fill="white" style="vertical-align: middle;">
                    <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                </svg>
                <div class="texts">
                    <h2 class="room-name">Room 1</h2>
                    <p onclick="renameRoom(this, event)">rename</p>
                </div>
            </div>
            <div class="room2 rooms room" data-room-id="2" onclick="selectRoom(2, this)">
                <svg class="logo" 
                    viewBox="0 0 512 512" fill="white" style="vertical-align: middle;">
                    <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                </svg>
                <div class="texts">
                    <h2 class="room-name">Room 2</h2>
                    <p onclick="renameRoom(this, event)">rename</p>
                </div>
            </div>
            <div class="room3 rooms room" data-room-id="3" onclick="selectRoom(3, this)">
                <svg class="logo" 
                    viewBox="0 0 512 512" fill="white" style="vertical-align: middle;">
                    <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                </svg>
                <div class="texts">
                    <h2 class="room-name">Room 3</h2>
                    <p onclick="renameRoom(this, event)">rename</p>
                </div>
            </div>
        </div>

        <div class="stats-div">
            <!-- Most Recent Emergency -->
            <div class="recent stats"> 
                <div>
                    <p>Most Recent Emergency</p>
                    <h2 id="recent-emergency"></h2>
                </div>
            </div>

            <!-- Monthly Detected Emergencies -->
            <div class="monthly stats">
                <div id="monthly-header">
                    <h3>Monthly Detected Emergencies</h3>
                    <select id="year-filter" onchange="updateMonthlyGraph()"></select>
                </div>
                <div class="chart-div">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Top Emergency Count -->
            <div class="top stats">
                <div id="top-header">
                    <h3>Top Emergency Count</h3>
                    <div id="top-filters">
                        <select id="top-range-filter" onchange="handleRangeChange()">
                            <option value="all">All Time</option>
                            <option value="this_year">This Year</option>
                            <option value="this_month">This Month</option>
                            <option value="last_7" selected>Last 7 Days</option>
                            <option value="last_30">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div class="date-inputs" id="custom-date-inputs">
                            <input type="date" id="start-date">
                            <span>to</span>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                </div>
                <div class="top-content">
                    <div class="pie-chart-container">
                        <canvas id="topChart"></canvas>
                        <div class="total-overlay">
                            <span class="total-label">Total</span>
                            <span class="total-value" id="total-emergencies">000</span>
                        </div>
                    </div>
                    <div class="room-stats" id="room-stats-container">
                        <!-- Room stats will be dynamically generated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <aside>
        <header>
            <h2>Room #</h2>
            <!-- <i class="fa-solid fa-pen-to-square"></i> -->
            <i class="fa-solid fa-pen" onclick="renameCurrentRoom(event)">✎</i>
        </header>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <p class="title">Alert History</p>
        </div>
        
        <div class="table-div">
            <table>
                <tr>
                    <th>Action</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </table>
        </div>
        <div class="pagination-controls">
            <button onclick="prevPage('aside')" id="aside-prev">Prev</button>
            <span id="aside-page-info"></span>
            <button onclick="nextPage('aside')" id="aside-next">Next</button>
        </div>
    </aside>

    <!-- mobile overlay -->
    <div class="popup-overlay" onclick="closePopup()"></div>
    <div class="popup-aside">        
        <header>
            <div>
                <h2>Room #</h2>
                <i class="fa-solid fa-pen" onclick="renameCurrentRoom(event)">✎</i>
            </div>
            <span class="fa-solid fa-times popup-close" onclick="closePopup()">x</span>
        </header>

        <div style="display: flex; align-items: end; justify-content: space-between;">
            <p class="title">Alert History</p>
        </div>
        
        <div class="table-div">
            <table>
                <tr>
                    <th>Action</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </table>
        </div>
        <div class="pagination-controls">
            <button onclick="prevPage('.popup-aside')" id="popup-prev">Prev</button>
            <span id="popup-page-info"></span>
            <button onclick="nextPage('.popup-aside')" id="popup-next">Next</button>
        </div>
    </div>

    <a href="/report" class="print-button" title="Generate Report">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="28" height="28">
            <path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zM432 248a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/>
        </svg>
    </a>

    <div class="audio-modal-overlay" id="audio-modal-overlay" onclick="closeAudioModal()">
        <div class="audio-modal" onclick="event.stopPropagation()">
            <div class="audio-modal-header">
                <h3>Emergency Recording</h3>
                <button class="audio-modal-close" onclick="closeAudioModal()">×</button>
            </div>
            <div class="audio-modal-body">
                <div class="audio-modal-info">
                    <p id="audio-datetime">01/15/26 at 2:30:45 PM</p>
                </div>
                <audio controls id="audio-player">
                    <source src="" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
                <div class="audio-modal-actions">
                    <a href="#" class="btn-audio-action btn-download-audio" id="audio-download" download>
                        Download
                    </a>
                    <button class="btn-audio-action btn-close-audio" onclick="closeAudioModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // REAL-TIME DATE AND TIME
        function updateDateTime() {
            const now = new Date();
            
            // Format date as MM/DD/YY
            const date = now.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            
            // Format time as HH:MM:SS AM/PM
            const time = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            document.getElementById('current-date').textContent = date;
            document.getElementById('current-time').textContent = time;
        }
        
        // Update immediately, then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // ====================================================================
        // ROOMS AND HISTORY        
        let roomData = {
            1: { name: "Room 1", history: [] },
            2: { name: "Room 2", history: [] },
            3: { name: "Room 3", history: [] }
        };

        let currentSelectedRoom = 1;
        const PAGE_SIZE = 9;
        let pageState = {
            'aside': 1,
            '.popup-aside': 1
        };

        // Fetch room data from API
        async function fetchRoomData() {
            try {
                const response = await fetch('/api/rooms');
                const rooms = await response.json();
                
                // Clear roomData
                roomData = {};
                
                // Preserve order from server by iterating through rooms object
                // The server already returns rooms in the correct order
                for (const [roomId, roomInfo] of Object.entries(rooms)) {
                    const id = parseInt(roomId);
                    roomData[id] = {
                        name: roomInfo.name,
                        history: [],
                        has_sensor: roomInfo.has_sensor
                    };
                }
                
                console.log('Room data loaded:', roomData);
                
                // Rebuild carousel with fetched rooms
                refreshRoomsCarousel();
                
            } catch (error) {
                console.error('Error fetching room data:', error);
            }
        }

        // Fetch history for a specific room
        async function fetchRoomHistory(roomId) {
            try {
                const response = await fetch(`/api/history/${roomId}`);
                const history = await response.json();
                roomData[roomId].history = history;
                return history;
            } catch (error) {
                console.error(`Error fetching history for room ${roomId}:`, error);
                return [];
            }
        }

        window.onload = async function() {
            await fetchRoomData();
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                await selectRoom(1, document.querySelector('.room1'));
            } else {
                currentSelectedRoom = 1;
            }
            updateAlertStates();
        };

        let currentAudioHistory = null;

        function openAudioModal(roomId, historyEntry) {
            if (!historyEntry.has_recording) {
                alert('No recording available for this alert.');
                return;
            }

            const modal = document.getElementById('audio-modal-overlay');
            const roomName = roomData[roomId]?.name || `Room ${roomId}`;
            
            document.getElementById('audio-datetime').textContent = `${historyEntry.date} at ${historyEntry.time}`;
            
            // Set audio source
            const audioPlayer = document.getElementById('audio-player');
            const audioUrl = `/api/history/${historyEntry.history_id}/recording`;
            audioPlayer.src = audioUrl;
            
            // Set download link
            const downloadLink = document.getElementById('audio-download');
            downloadLink.href = audioUrl;
            downloadLink.download = `emergency_room${roomId}_${historyEntry.date.replace(/\//g, '-')}.wav`;
            
            modal.classList.add('show');
            currentAudioHistoryId = historyEntry.history_id;
            
            // Auto-play
            audioPlayer.play().catch(e => console.log('Autoplay prevented:', e));
        }

        function closeAudioModal() {
            const modal = document.getElementById('audio-modal-overlay');
            const audioPlayer = document.getElementById('audio-player');
            
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            modal.classList.remove('show');
            currentAudioHistoryId = null;
        }

        // Close modal on ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAudioModal();
                closeAdminModal();
                closePopup();
            }
        });

        // select room
        async function selectRoom(roomNumber, roomElement) {
            currentSelectedRoom = roomNumber;
            pageState['aside'] = 1;
            pageState['.popup-aside'] = 1;
            
            // Fetch fresh history data
            await fetchRoomHistory(roomNumber);
            
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
                roomElement.classList.add('active-room');
                const roomName = roomData[roomNumber].name;
                document.querySelector('aside header h2').textContent = roomName;
                updateHistoryTable(roomNumber, 'aside');
            } else {
                const roomName = roomData[roomNumber].name;
                document.querySelector('.popup-aside header h2').textContent = roomName;
                updateHistoryTable(roomNumber, '.popup-aside');
                showPopup();
            }

            updateEmergencyBannerForRoom(roomNumber);
        }

        function updateHistoryTable(roomNumber, container) {
            const tableBody = document.querySelector(`${container} table`);
            const history = roomData[roomNumber].history;
            const page = pageState[container];
            const start = (page - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pagedHistory = history.slice(start, end);

            // clear existing rows (keep header)
            while (tableBody.rows.length > 1) {
                tableBody.deleteRow(1);
            }

            if (history.length == 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 3;
                cell.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <p style="margin: 0; font-size: 0.95rem;">No alert history yet</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: #bbb;">Emergencies will appear here when detected</p>
                    </div>
                `;

                const pageInfo = document.querySelector(
                    container === 'aside' ? '#aside-page-info' : '#popup-page-info'
                );

                pageInfo.textContent = '0 of 0';
                
                const prevBtn = document.querySelector(
                    container === 'aside' ? '#aside-prev' : '#popup-prev'
                );
                const nextBtn = document.querySelector(
                    container === 'aside' ? '#aside-next' : '#popup-next'
                );
                prevBtn.disabled = true;
                nextBtn.disabled = true;

                return;
            }

            let recentUnacknowledgedAlarmId = null;

            if(history.length > 0) { 
                const firstEntry = history[0];
                if (firstEntry.action === "Emergency Alert Detected" || firstEntry.action === "Alarming Alert Detected") {
                    recentUnacknowledgedAlarmId = firstEntry.history_id;
                }
            }

            pagedHistory.forEach(entry => {
                const row = tableBody.insertRow();
                row.className = 'history-row';
                
                const isEmergency = entry.action === "Emergency Alert Detected"
                const isAlarming = entry.action === "Alarming Alert Detected";
                const isAcknowledged = entry.action === "Alert Acknowledged";
                const hasRecording = entry.has_recording;
            
                if (entry.history_id === recentUnacknowledgedAlarmId) {
                    if (isEmergency) {
                        row.classList.add('new-emergency');
                    } else if (isAlarming) {
                        row.classList.add('new-alarming');
                    }
                }

                const actionCell = row.insertCell(0);
                
                // Prepare action text with optional sound_type
                let actionHTML = '';
                if (isEmergency && entry.sound_type && hasRecording) {
                    row.classList.add('has-audio');
                    row.title = 'Click to play recording';
                    row.onclick = () => openAudioModal(roomNumber, entry);
                    actionHTML = `
                        <div class="action-icon">
                            <svg class="play-icon" viewBox="0 0 384 512">
                                <path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/>
                            </svg>
                            <div class="emergency">
                                <svg viewBox="0 0 448 512">
                                    <path d="M224 0c-17.7 0-32 14.3-32 32V51.2C119 66 64 130.6 64 208v18.8c0 47-17.3 92.4-48.5 127.6l-7.4 8.3c-8.4 9.4-10.4 22.9-5.3 34.4S19.4 416 32 416H416c12.6 0 24-7.4 29.2-18.9s3.1-25-5.3-34.4l-7.4-8.3C401.3 319.2 384 273.9 384 226.8V208c0-77.4-55-142-128-156.8V32c0-17.7-14.3-32-32-32zm45.3 493.3c12-12 18.7-28.3 18.7-45.3H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7z"/>
                                </svg>
                            </div>
                            <p style="color: var(--second-light);">  ${entry.sound_type} Detected</p>
                        </div>
                    `;
                } else if (isAlarming && entry.sound_type && hasRecording) {
                    row.classList.add('has-audio');
                    row.title = 'Click to play recording';
                    row.onclick = () => openAudioModal(roomNumber, entry);
                    actionHTML = `
                        <div class="action-icon">
                            <svg class="play-icon" viewBox="0 0 384 512">
                                <path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/>
                            </svg>
                            <div class="alarming">
                                <svg viewBox="0 0 448 512">
                                    <path d="M224 0c-17.7 0-32 14.3-32 32V51.2C119 66 64 130.6 64 208v18.8c0 47-17.3 92.4-48.5 127.6l-7.4 8.3c-8.4 9.4-10.4 22.9-5.3 34.4S19.4 416 32 416H416c12.6 0 24-7.4 29.2-18.9s3.1-25-5.3-34.4l-7.4-8.3C401.3 319.2 384 273.9 384 226.8V208c0-77.4-55-142-128-156.8V32c0-17.7-14.3-32-32-32zm45.3 493.3c12-12 18.7-28.3 18.7-45.3H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7z"/>
                                </svg>
                            </div>
                            <p style="color: var(--second-light);">  ${entry.sound_type} Detected</p>
                        </div>
                    `;
                } else if (isAcknowledged) {
                    actionHTML = `
                        <div class="action-icon acknowledged">
                            <svg viewBox="0 0 512 512">
                                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                            </svg>
                            <p>${entry.action}</p>
                        </div>
                    `;
                } else {
                    actionHTML = entry.action;
                }
                
                actionCell.innerHTML = actionHTML;

                row.insertCell(1).textContent = entry.date;
                row.insertCell(2).textContent = entry.time;
            });

            // PAGINATION
            const totalPages = Math.ceil(history.length / PAGE_SIZE);
            const pageInfo = document.querySelector(
                container === 'aside' ? '#aside-page-info' : '#popup-page-info'
            );
            pageInfo.textContent = `${page} of ${totalPages}`;

            const prevBtn = document.querySelector(
                container === 'aside' ? '#aside-prev' : '#popup-prev'
            );
            const nextBtn = document.querySelector(
                container === 'aside' ? '#aside-next' : '#popup-next'
            );
            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages;
        }

        function prevPage(container) {
            if (pageState[container] > 1) {
                pageState[container]--;
                updateHistoryTable(currentSelectedRoom, container);
            }
        }

        function nextPage(container) {
            const history = roomData[currentSelectedRoom].history;
            const totalPages = Math.ceil(history.length / PAGE_SIZE);
            if (pageState[container] < totalPages) {
                pageState[container]++;
                updateHistoryTable(currentSelectedRoom, container);
            }
        }

        // POPUP
        function showPopup() {
            const overlay = document.querySelector('.popup-overlay');
            const popup = document.querySelector('.popup-aside');
            overlay.classList.add('show');
            popup.classList.add('show');
            const currentRoom = document.querySelector(`.room${currentSelectedRoom}`);
            if (currentRoom) {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
                currentRoom.classList.add('active-room');
            }
            document.body.style.overflow = 'hidden';
        }

        function closePopup() {
            const overlay = document.querySelector('.popup-overlay');
            const popup = document.querySelector('.popup-aside');
            overlay.classList.remove('show');
            popup.classList.remove('show');
            document.querySelectorAll('.rooms').forEach(room => {
                room.classList.remove('active-room');
            });
            document.body.style.overflow = 'auto';
        }

        function ensureActiveRoomState() {
            const activeRoom = document.querySelector(`.room${currentSelectedRoom}`);
            if (activeRoom && !activeRoom.classList.contains('active-room')) {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
                activeRoom.classList.add('active-room');
            }
        }

        // RENAME ROOM
        async function renameRoom(renameElement, event) {
            event.stopPropagation();
            const roomNameElement = renameElement.previousElementSibling;
            const currentName = roomNameElement.textContent;
            const roomDiv = renameElement.closest('.rooms');
            let roomNumber;
            if (roomDiv.classList.contains('room1')) {
                roomNumber = 1;
            } else if (roomDiv.classList.contains('room2')) {
                roomNumber = 2;
            } else if (roomDiv.classList.contains('room3')) {
                roomNumber = 3;
            }
            const newName = prompt(`Enter new name for ${currentName}:`, currentName);
            if (newName !== null && newName.trim() !== '') {
                const trimmedName = newName.trim();
                
                try {
                    const response = await fetch(`/api/rooms/${roomNumber}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ new_name: trimmedName })
                    });
                    
                    if (response.ok) {
                        roomNameElement.textContent = trimmedName;
                        roomData[roomNumber].name = trimmedName;
                        if (roomDiv.classList.contains('active-room')) {
                            const desktopHeader = document.querySelector('aside header h2');
                            const mobileHeader = document.querySelector('.popup-aside header h2');
                            if (desktopHeader) desktopHeader.textContent = trimmedName;
                            if (mobileHeader) mobileHeader.textContent = trimmedName;
                        }
                    } else {
                        alert('Failed to rename room');
                    }
                } catch (error) {
                    console.error('Error renaming room:', error);
                    alert('Error renaming room');
                }
            }
        }

        // RENAME ROOM USING PEN ICON
        async function renameCurrentRoom(event) {
            event.stopPropagation();
            
            const currentName = roomData[currentSelectedRoom].name;
            const newName = prompt(`Enter new name for ${currentName}:`, currentName);
            
            if (newName !== null && newName.trim() !== '') {
                const trimmedName = newName.trim();
                
                try {
                    const response = await fetch(`/api/rooms/${currentSelectedRoom}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ new_name: trimmedName })
                    });
                    
                    if (response.ok) {
                        // Update the room name in the data
                        roomData[currentSelectedRoom].name = trimmedName;
                        
                        // Update the room card name
                        document.querySelector(`.room${currentSelectedRoom} h2`).textContent = trimmedName;
                        
                        // Update the aside header
                        document.querySelector('aside header h2').textContent = trimmedName;
                        
                        // Update the popup header if it's open
                        const popupHeader = document.querySelector('.popup-aside header h2');
                        if (popupHeader) {
                            popupHeader.textContent = trimmedName;
                        }
                    } else {
                        alert('Failed to rename room');
                    }
                } catch (error) {
                    console.error('Error renaming room:', error);
                    alert('Error renaming room');
                }
            }
        }

        window.addEventListener('resize', function() {
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                closePopup();
                const roomName = roomData[currentSelectedRoom].name;
                document.querySelector('aside header h2').textContent = roomName;
                updateHistoryTable(currentSelectedRoom, 'aside');
                const currentRoom = document.querySelector(`.room${currentSelectedRoom}`);
                if (currentRoom) {
                    document.querySelectorAll('.rooms').forEach(room => {
                        room.classList.remove('active-room');
                    });
                    currentRoom.classList.add('active-room');
                }
            } else {
                document.querySelectorAll('.rooms').forEach(room => {
                    room.classList.remove('active-room');
                });
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePopup();
            }
        });

        // ====================================================================
        // MOST RECENT EMERGENCY
        async function fetchRecentEmergency() {
            try {
                const response = await fetch('/api/recent_emergency');
                const data = await response.json();
                const elem = document.getElementById('recent-emergency');
                if (data && data.date && data.time) {
                    elem.textContent = `${data.date} @\u00A0${data.time.replace(' ', '\u00A0')}`;
                } else {
                    elem.textContent = "No emergencies yet";
                }
            } catch (error) {
                document.getElementById('recent-emergency').textContent = "Error loading";
            }
        }

        window.onload = async function() {
            await fetchRoomData();
            await fetchRecentEmergency();
            
            // Check all room statuses from history on page load
            await updateAllRoomStatusesFromHistory();
            
            // Connect WebSocket for real-time updates
            connectWebSocket();
            
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                await selectRoom(1, document.querySelector('.room1'));
            } else {
                currentSelectedRoom = 1;
            }
        };

        // ====================================================================
        // REAL-TIME ALERTS WITH WEBSOCKET
        let roomStatus = {1: 0, 2: 0, 3: 0};
        let websocket = null;
        let reconnectInterval = null;

        // Check the latest history status for each room
        async function updateRoomStatusFromHistory(roomId) {
            try {
                const response = await fetch(`/api/history/${roomId}`);
                const history = await response.json();
                
                if (history && history.length > 0) {
                    const latestAction = history[0].action; // Most recent record
                    
                    if (latestAction === "Emergency Alert Detected" || latestAction === "Alarming Alert Detected") {
                        roomStatus[roomId] = 1; // Bell should animate
                        console.log(`Room ${roomId} latest: Alert Detected - bell animating`);
                    } else if (latestAction === "Alert Acknowledged") {
                        roomStatus[roomId] = 0; // Bell should stop
                        console.log(`Room ${roomId} latest: Alert Acknowledged - bell stopped`);
                    }
                } else {
                    roomStatus[roomId] = 0; // No history = normal state
                }
                
                updateAlertStates();
            } catch (error) {
                console.error(`Error checking room ${roomId} status:`, error);
            }
        }

        // Update all room statuses from their history
        async function updateAllRoomStatusesFromHistory() {
            for (let roomId = 1; roomId <= 3; roomId++) {
                await updateRoomStatusFromHistory(roomId);
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('Attempting to connect to WebSocket:', wsUrl);
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('✓ WebSocket connected successfully!');
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                    
                    // Check history status when connected
                    updateAllRoomStatusesFromHistory();
                };
                
                websocket.onmessage = function(event) {
                    console.log('WebSocket message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Parsed data:', data);
                        
                        if (data.type === 'alert_update') {
                            console.log('Alert update received:', data);
                            
                            // Check the latest history to determine bell state
                            updateRoomStatusFromHistory(data.room_id);
                            
                            // Refresh recent emergency section
                            fetchRecentEmergency();

                            if (data.action === "Alert Acknowledged") {
                                removeHighlightInstance(data.room_id);
                            }
                            
                            // Refresh history for the affected room
                            fetchRoomHistory(data.room_id).then(() => {
                                // Update the table if we're currently viewing this room
                                if (currentSelectedRoom === data.room_id) {
                                    const aside = document.querySelector('aside');
                                    const isDesktop = window.getComputedStyle(aside).display !== 'none';
                                    if (isDesktop) {
                                        updateHistoryTable(data.room_id, 'aside');
                                    } else {
                                        const popup = document.querySelector('.popup-aside');
                                        if (popup.classList.contains('show')) {
                                            updateHistoryTable(data.room_id, '.popup-aside');
                                        }
                                    }
                                }
                            });
                            
                            // Update graphs
                            updateMonthlyGraph();
                            updateTopChart();
                        } else if (data.type === 'room_renamed') {
                            console.log('Room renamed:', data);
                            // Update room name in UI
                            const roomCard = document.querySelector(`.room[data-room-id="${data.room_id}"]`);
                            if (roomCard) {
                                const nameElement = roomCard.querySelector('.room-name');
                                if (nameElement) {
                                    nameElement.textContent = data.new_name;
                                }
                            }
                            
                            // Update in roomData
                            if (roomData[data.room_id]) {
                                roomData[data.room_id].name = data.new_name;
                            }
                            
                            // Update aside headers if this is the current room
                            if (currentSelectedRoom === data.room_id) {
                                document.querySelector('aside header h2').textContent = data.new_name;
                                const popupHeader = document.querySelector('.popup-aside header h2');
                                if (popupHeader) {
                                    popupHeader.textContent = data.new_name;
                                }
                            }
                            
                            // Update top chart room labels
                            updateTopChart();
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket disconnected. Attempting to reconnect...');
                    websocket = null;
                    
                    // Attempt to reconnect every 3 seconds
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            console.log('Reconnecting...');
                            connectWebSocket();
                        }, 3000);
                    }
                };
                
            } catch (error) {
                console.error('Error creating WebSocket:', error);
            }
        }

        function removeHighlightInstance(roomId) {
            const containers = ['aside', '.popup-aside'];
    
            containers.forEach(container => {
                const rows = document.querySelectorAll(`${container} .history-row.new-emergency, ${container} .history-row.new-alarming`);
                
                rows.forEach(row => {
                    row.classList.remove('new-emergency', 'new-alarming');
                    row.classList.add('acknowledged-highlight');
                    
                    setTimeout(() => {
                        row.classList.remove('acknowledged-highlight');
                        row.classList.add('fade-highlight');
                        
                        setTimeout(() => {
                            row.classList.remove('fade-highlight');
                        }, 500);
                    }, 2000);
                });
            });
        }

        function updateAlertStates() {
            console.log('Updating alert states with:', roomStatus);
            
            // Update each room card
            for (let roomId in roomStatus) {
                const roomCard = document.querySelector(`.room[data-room-id="${roomId}"]`);
                if (roomCard) {
                    const statusValue = roomStatus[roomId];
                    console.log(`Room ${roomId} card found, status: ${statusValue}`);
                    
                    if (statusValue === 1) {
                        // Latest history is "Emergency Alert Detected" or "Alarming Alert Detected" - bell should blink
                        roomCard.classList.add('alert-active');
                        console.log(`Room ${roomId} set to alert-active - bell blinking`);
                    } else {
                        // Latest history is "Alert Acknowledged" or no history - stop blinking
                        roomCard.classList.remove('alert-active');
                        console.log(`Room ${roomId} alert cleared - bell stopped blinking`);
                    }
                } else {
                    console.warn(`Room card not found for room ${roomId}`);
                }
            }
        }

        // Initialize WebSocket connection when page loads
        updateEmergencyBannerForRoom(currentSelectedRoom);
    </script>

    <!-- GRAPHS -->
    <script>
        // MONTHLY DETECTED EMERGENCIES
        let monthlyChart = null;

        // Aspect ratio helper based on screen width
        function getLineChartAspectRatio() {
            const w = window.innerWidth;
            if (w >= 1440) return 1.5;  
            if (w >= 1358) return 1.3;  
            if (w >= 1274) return 1.8;  
            if (w >= 1128) return 1.1;  
            if (w >= 1024) return .9;  
            if (w >= 900) return .7;  
            if (w >= 769)  return 1.8;  
            if (w >= 735)  return 1.4;   
            if (w >= 600)  return 1.1;   
            if (w >= 520)  return 1.1;   
            if (w >= 441)  return .7;   
            if (w >= 320)  return 1.5;   
            return 1.1;                 
        }

        let monthlyResizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(monthlyResizeTimer);
            monthlyResizeTimer = setTimeout(() => {
                if (monthlyChart) {
                    monthlyChart.options.aspectRatio = getLineChartAspectRatio();
                    monthlyChart.resize();
                    monthlyChart.update();
                }
            }, 150);
        });

        async function initializeYearFilter() {
            try {
                const response = await fetch('/api/available_years');
                const years = await response.json();
                
                const yearFilter = document.getElementById('year-filter');
                yearFilter.innerHTML = '';
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
                
                // Load data for the first year
                if (years.length > 0) {
                    await updateMonthlyGraph();
                }
            } catch (error) {
                console.error('Error loading years:', error);
            }
        }

        async function updateMonthlyGraph() {
            const yearFilter = document.getElementById('year-filter');
            const selectedYear = yearFilter.value;
            
            try {
                const response = await fetch(`/api/monthly_emergencies/${selectedYear}`);
                const data = await response.json();
                
                console.log('Raw monthly data received:', data);
                
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // The data should already be an array of 12 values [count_jan, count_feb, ..., count_dec]
                let values;
                if (Array.isArray(data)) {
                    values = data;
                } else {
                    // Fallback: convert object to array
                    values = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    for (const [month, count] of Object.entries(data)) {
                        const monthIndex = parseInt(month) - 1; // month is 1-12, array is 0-11
                        if (monthIndex >= 0 && monthIndex < 12) {
                            values[monthIndex] = count;
                        }
                    }
                }
                
                console.log('Processed values for chart:', values);
                console.log('October (index 9) value:', values[9]);
                
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                
                monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Monthly Detected Emergencies',
                            data: values,
                            borderColor: '#015382', //second-light
                            backgroundColor: 'rgba(136, 143, 167, 0.20)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#002C47', //second
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: getLineChartAspectRatio(),
                        plugins: {
                            filler: {
                                propagate: false
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#002C47', //second
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#015382', //second-light
                                borderWidth: 1,
                                displayColors: false,
                                intersect: false,
                                mode: 'index',
                                callbacks: {
                                    label: function(context) {
                                        return `Emergencies: ${context.parsed.y}`;
                                    },
                                    title: function(context) {
                                        return `${context[0].label} ${selectedYear}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    color: '#666',
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#666'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error updating monthly graph:', error);
            }
        }

        // TOP EMERGENCY COUNT PIE CHART
        let topChart = null;

        function handleRangeChange() {
            const rangeFilter = document.getElementById('top-range-filter');
            const customInputs = document.getElementById('custom-date-inputs');
            
            if (rangeFilter.value === 'custom') {
                customInputs.classList.add('show');
                // Set default dates
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                document.getElementById('end-date').valueAsDate = today;
                document.getElementById('start-date').valueAsDate = thirtyDaysAgo;
                
                // Update chart with default custom range
                applyCustomRange();
            } else {
                customInputs.classList.remove('show');
                updateTopChart();
            }
        }

        async function applyCustomRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            await updateTopChart();
        }

        // Add event listeners for Enter key on date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const startDate = document.getElementById('start-date');
            const endDate = document.getElementById('end-date');
            
            if (startDate && endDate) {
                startDate.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyCustomRange();
                });
                endDate.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyCustomRange();
                });
                
                // Auto-apply when both dates are selected
                endDate.addEventListener('change', function() {
                    if (startDate.value && endDate.value) {
                        applyCustomRange();
                    }
                });
            }
        });

        async function updateTopChart() {
            const rangeFilter = document.getElementById('top-range-filter');
            const selectedRange = rangeFilter.value;
            
            let url = '/api/top_emergencies';
            
            if (selectedRange === 'custom') {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                if (!startDate || !endDate) {
                    console.warn('Custom range selected but dates not set');
                    return;
                }
                
                url += `?range=custom&start_date=${startDate}&end_date=${endDate}`;
            } else if (selectedRange !== 'all') {
                url += `?range=${selectedRange}`;
            }
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Update total
                document.getElementById('total-emergencies').textContent = 
                    data.total.toString().padStart(3, '0');
                
                // Dynamically create room stats for all rooms
                const roomStatsContainer = document.getElementById('room-stats-container');
                roomStatsContainer.innerHTML = '';
                
                // Get all rooms and sort by emergency count (highest first)
                const roomIds = Object.keys(roomData);
                const sortedRoomIds = roomIds.sort((a, b) => {
                    const countA = data.rooms[a]?.count || 0;
                    const countB = data.rooms[b]?.count || 0;
                    
                    // Sort by count descending (most emergencies first)
                    if (countB !== countA) {
                        return countB - countA;
                    }
                    
                    // If counts are equal, sort by sensor status (with sensor first)
                    const roomA = roomData[a];
                    const roomB = roomData[b];
                    if (roomA.has_sensor !== roomB.has_sensor) {
                        return roomB.has_sensor ? 1 : -1;
                    }
                    
                    // If still equal, sort alphabetically
                    return roomA.name.toLowerCase().localeCompare(roomB.name.toLowerCase());
                });
                
                // Create stat elements for each room in sorted order
                sortedRoomIds.forEach(roomId => {
                    const roomInfo = data.rooms[roomId] || { name: roomData[roomId].name, count: 0 };
                    const statDiv = document.createElement('div');
                    statDiv.className = 'room-stat';
                    statDiv.id = `room-stat-${roomId}`;
                    statDiv.innerHTML = `
                        <span class="room-label">${roomInfo.name}</span>
                        <span class="room-count">${roomInfo.count.toString().padStart(2, '0')}</span>
                    `;
                    roomStatsContainer.appendChild(statDiv);
                });
                
                // Create pie chart (only with rooms that have data)
                const ctx = document.getElementById('topChart').getContext('2d');
                
                if (topChart) {
                    topChart.destroy();
                }
                
                const sortedRooms = Object.entries(data.rooms)
                    .filter(([_, roomData]) => roomData.count > 0)
                    .sort((a, b) => b[1].count - a[1].count);
                
                const labels = sortedRooms.map(([_, roomData]) => roomData.name);
                const values = sortedRooms.map(([_, roomData]) => roomData.count);
                
                // Generate colors dynamically based on number of rooms
                const colors = ['#015382', '#2d8ec2', '#002C47', '#4a9fd8', '#1a6b99', '#357ab8'];
                
                topChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, values.length),
                            borderWidth: 0,
                            cutout: '50%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#002C47',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#015382',
                                borderWidth: 1,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 
                                            ? ((context.parsed / total) * 100).toFixed(1) 
                                            : 0;
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: 0
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating top chart:', error);
            }
        }
        // Initialize both charts on page load
        window.addEventListener('load', async function() {
            await initializeYearFilter();
            await updateTopChart(); 
        });
    </script>

    <!-- OVERLAY -->
    <script>
        function openAdminModal() {
            const overlay = document.getElementById('admin-overlay');
            const modal = document.getElementById('admin-modal');
            overlay.classList.add('show');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            // Refresh data when opened
            try { loadDevices(); } catch(e) {}
            // Focus input
            const input = document.getElementById('new-room-name');
            if (input) { setTimeout(() => input.focus(), 50); }
        }

        function closeAdminModal() {
            const overlay = document.getElementById('admin-overlay');
            const modal = document.getElementById('admin-modal');
            overlay.classList.remove('show');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            
            // Refresh the room data and carousel to reflect any changes
            fetchRoomData().then(() => {
                // If a room is selected, refresh its display
                if (currentSelectedRoom) {
                    const aside = document.querySelector('aside');
                    const isDesktop = window.getComputedStyle(aside).display !== 'none';
                    if (isDesktop) {
                        const currentRoom = document.querySelector(`.room[data-room-id="${currentSelectedRoom}"]`);
                        if (currentRoom) {
                            selectRoom(currentSelectedRoom, currentRoom);
                        }
                    }
                }
            });
        }

        // Close admin modal on ESC as well
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAdminModal();
            }
        });
                
        async function createRoom() {
            const nameEl = document.getElementById('new-room-name');
            const room_name = nameEl.value.trim();
            if (!room_name) { alert("Enter room name"); return; }
            try {
                const r = await fetch('/api/rooms', {
                method: 'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({room_name})
                });
                if (!r.ok) throw new Error(await r.text());
                nameEl.value = '';
                await fetchRoomData();
                updateMonthlyGraph();
                updateTopChart();
                loadDevices(); // refresh
            } catch(e){ console.error(e); alert("Failed to add room"); }
        }

        async function loadDevices() {
            try {
                const [devicesResp, roomsResp] = await Promise.all([
                    fetch('/api/devices'),
                    fetch('/api/rooms')
                ]);
                
                const devices = await devicesResp.json();
                const rooms = await roomsResp.json();
                
                const tbody = document.getElementById('device-table-body');
                
                // Create a map of room_id -> device info
                const roomToDevice = {};
                devices.forEach(d => {
                    if (d.room_id !== 0) {
                        roomToDevice[d.room_id] = d.address;
                    }
                });
                
                // Create available sensors list (devices not assigned or with room_id = 0)
                const availableDevices = devices.filter(d => d.room_id === 0);
                
                // Sort room IDs
                const sortedRoomIds = Object.keys(rooms).sort((a, b) => parseInt(a) - parseInt(b));
                
                if (sortedRoomIds.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-devices-row">No rooms available. Create a room first.</td></tr>';
                    return;
                }
                
                let sensorCounter = 1;
                const deviceLabels = {}; // Map address -> "Sensor #X"
                
                // First pass: label all devices
                devices.forEach(d => {
                    deviceLabels[d.address] = `Sensor #${sensorCounter++}`;
                });
                
                tbody.innerHTML = sortedRoomIds.map(roomId => {
                    const room = rooms[roomId];
                    const assignedDeviceId = roomToDevice[roomId];
                    const sensorLabel = assignedDeviceId ? deviceLabels[assignedDeviceId] : null;
                    
                    return `
                        <tr>
                            <td class="room-name-cell">${room.name}</td>
                            <td class="sensor-info">
                                ${sensorLabel ? sensorLabel : '<span class="no-sensor">No sensor assigned</span>'}
                            </td>
                            <td>
                                <select data-room="${roomId}" onchange="assignSensorToRoom(this)">
                                    <option value="" style="color: #015382;">Select Sensor</option>
                                    ${assignedDeviceId ? `<option value="${assignedDeviceId}" selected>${deviceLabels[assignedDeviceId]}</option>` : ''}
                                    ${availableDevices.map(d => 
                                        `<option value="${d.address}">${deviceLabels[d.address]}</option>`
                                    ).join('')}
                                    ${assignedDeviceId ? '<option value="unassign">Remove Sensor</option>' : ''}
                                </select>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action" onclick="renameRoomFromTable(${roomId}, '${room.name.replace(/'/g, "\\'")}')">
                                        Rename
                                    </button>
                                    <button class="btn-action btn-delete" onclick="deleteRoom(${roomId}, '${room.name.replace(/'/g, "\\'")}')">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('Failed to load devices:', err);
                document.getElementById('device-table-body').innerHTML = 
                    '<tr><td colspan="4" class="no-devices-row">Unable to load data. Please refresh.</td></tr>';
            }
        }

        async function deleteRoom(roomId, roomName) {
            const confirmDelete = confirm(`Are you sure you want to delete "${roomName}"?\n\nThis will remove all emergency history for this room and cannot be undone.`);
            
            if (!confirmDelete) {
                return;
            }

            try {
                const response = await fetch(`/api/rooms/${roomId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove from roomData
                    delete roomData[roomId];
                    
                    // Remove room card if exists
                    const roomCard = document.querySelector(`.room[data-room-id="${roomId}"]`);
                    if (roomCard) {
                        roomCard.remove();
                    }
                    
                    // If this was the selected room, switch to another room
                    if (currentSelectedRoom === roomId) {
                        const remainingRooms = Object.keys(roomData).map(id => parseInt(id));
                        if (remainingRooms.length > 0) {
                            const newRoomId = remainingRooms[0];
                            const newRoomCard = document.querySelector(`.room[data-room-id="${newRoomId}"]`);
                            if (newRoomCard) {
                                await selectRoom(newRoomId, newRoomCard);
                            }
                        }
                    }
                    
                    // Refresh the table
                    await loadDevices();
                    
                    // Update graphs
                    updateMonthlyGraph();
                    updateTopChart();
                    
                    alert(`"${roomName}" has been deleted successfully.`);
                } else {
                    const error = await response.json();
                    alert(`Failed to delete room: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room. Please try again.');
            }
        }

        async function assignSensorToRoom(sel) {
            const roomId = parseInt(sel.getAttribute('data-room'));
            const deviceId = sel.value;
            
            if (!deviceId) {
                alert('Please select a sensor.');
                await loadDevices();
                return;
            }
            
            if (deviceId === 'unassign') {
                // Find the device currently assigned to this room and unassign it
                try {
                    const devicesResp = await fetch('/api/devices');
                    const devices = await devicesResp.json();
                    const currentDevice = devices.find(d => d.room_id === roomId);
                    
                    if (currentDevice) {
                        const resp = await fetch(`/api/devices/${encodeURIComponent(currentDevice.address)}/assign_room`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({room_id: 0}) // Unassign
                        });
                        
                        if (resp.ok) {
                            await loadDevices();
                            updateTopChart();
                        } else {
                            alert('Failed to remove sensor.');
                            await loadDevices();
                        }
                    }
                } catch (err) {
                    console.error('Error removing sensor:', err);
                    alert('Error removing sensor.');
                    await loadDevices();
                }
                return;
            }

            try {
                const resp = await fetch(`/api/devices/${encodeURIComponent(deviceId)}/assign_room`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({room_id: roomId})
                });
                
                if (resp.ok) {
                    await loadDevices();
                    updateTopChart();
                } else {
                    alert('Failed to assign sensor.');
                    await loadDevices();
                }
            } catch (err) {
                console.error('Error assigning sensor:', err);
                alert('Error assigning sensor.');
                await loadDevices();
            }
        }

        async function renameRoomFromTable(roomId, currentName) {
            const newName = prompt(`Enter new name for ${currentName}:`, currentName);
            
            if (newName !== null && newName.trim() !== '' && newName.trim() !== currentName) {
                const trimmedName = newName.trim();
                
                try {
                    const response = await fetch(`/api/rooms/${roomId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ new_name: trimmedName })
                    });
                    
                    if (response.ok) {
                        // Update roomData
                        roomData[roomId].name = trimmedName;
                        
                        // Update room card if exists
                        const roomCard = document.querySelector(`.room[data-room-id="${roomId}"]`);
                        if (roomCard) {
                            roomCard.querySelector('.room-name').textContent = trimmedName;
                        }
                        
                        // Update aside if this is current room
                        if (currentSelectedRoom === roomId) {
                            document.querySelector('aside header h2').textContent = trimmedName;
                            const popupHeader = document.querySelector('.popup-aside header h2');
                            if (popupHeader) popupHeader.textContent = trimmedName;
                        }
                        
                        // Refresh table
                        await loadDevices();
                        updateTopChart();
                    } else {
                        alert('Failed to rename room.');
                    }
                } catch (error) {
                    console.error('Error renaming room:', error);
                    alert('Error renaming room.');
                }
            }
        }

        function buildRoomOptions(current) {
            let opts = '';
            
            // Sort room IDs numerically
            const sortedRoomIds = Object.keys(roomData).sort((a, b) => parseInt(a) - parseInt(b));
            
            // Add all room options
            for (const id of sortedRoomIds) {
                const sel = parseInt(id) === parseInt(current) ? 'selected' : '';
                opts += `<option value="${id}" ${sel}>${roomData[id].name}</option>`;
            }
            
            return opts;
        }

        async function assignDeviceFromTable(sel) {
            const deviceId = sel.getAttribute('data-device');
            const roomId = parseInt(sel.value);
            
            if (roomId === 0) {
                alert('Please select a room.');
                await loadDevices();
                return;
            }

            try {
                const resp = await fetch(`/api/devices/${encodeURIComponent(deviceId)}/assign_room`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({room_id: roomId})
                });
                
                if (resp.ok) {
                    await loadDevices();
                    updateTopChart();
                } else {
                    alert('Failed to assign sensor.');
                    await loadDevices();
                }
            } catch (err) {
                console.error('Error assigning device:', err);
                alert('Error assigning sensor.');
                await loadDevices();
            }
        }

        setInterval(loadDevices, 10000); // refresh list
            window.addEventListener('load', () => {
            setTimeout(loadDevices, 1500);
        });
    </script>

    <script>
        // CAROUSEL FOR ROOMS
        let currentCarouselIndex = 0;
        const ROOMS_VISIBLE = 3;

        function initializeRoomsCarousel() {
            const roomsDiv = document.querySelector('.rooms-div');
            
            // Check if already initialized
            if (roomsDiv.querySelector('.carousel-prev')) {
                return;
            }
            
            // Create navigation buttons
            const prevBtn = document.createElement('button');
            prevBtn.className = 'carousel-prev';
            prevBtn.innerHTML = '←';
            prevBtn.onclick = () => navigateCarousel(-1);
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'carousel-next';
            nextBtn.innerHTML = '→';
            nextBtn.onclick = () => navigateCarousel(1);
            
            // Wrap existing rooms in a container
            const rooms = Array.from(roomsDiv.querySelectorAll('.room'));
            const container = document.createElement('div');
            container.className = 'rooms-container';
            
            rooms.forEach(room => container.appendChild(room));
            roomsDiv.innerHTML = '';
            roomsDiv.appendChild(prevBtn);
            roomsDiv.appendChild(container);
            roomsDiv.appendChild(nextBtn);
            
            updateCarousel();
        }

        function navigateCarousel(direction) {
            const totalRooms = Object.keys(roomData).length;
            const maxIndex = Math.max(0, totalRooms - ROOMS_VISIBLE);
            
            currentCarouselIndex += direction;
            
            // Clamp the index
            if (currentCarouselIndex < 0) {
                currentCarouselIndex = 0;
            } else if (currentCarouselIndex > maxIndex) {
                currentCarouselIndex = maxIndex;
            }
            
            updateCarousel();
        }

        function updateCarousel() {
            const container = document.querySelector('.rooms-container');
            if (!container) return;
            
            const rooms = container.querySelectorAll('.room');
            const totalRooms = rooms.length;
            
            // If 3 or fewer rooms, show all
            if (totalRooms <= ROOMS_VISIBLE) {
                rooms.forEach(room => {
                    room.style.display = 'flex';
                });
                
                // Disable both buttons
                const prevBtn = document.querySelector('.carousel-prev');
                const nextBtn = document.querySelector('.carousel-next');
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
                
                return;
            }
            
            // Hide all rooms first
            rooms.forEach(room => {
                room.style.display = 'none';
            });
            
            // Show only 3 consecutive rooms starting from currentCarouselIndex
            const endIdx = Math.min(currentCarouselIndex + ROOMS_VISIBLE, totalRooms);
            
            for (let i = currentCarouselIndex; i < endIdx; i++) {
                if (rooms[i]) {
                    rooms[i].style.display = 'flex';
                }
            }
            
            // Update navigation buttons
            const prevBtn = document.querySelector('.carousel-prev');
            const nextBtn = document.querySelector('.carousel-next');
            const maxIndex = totalRooms - ROOMS_VISIBLE;
            
            if (prevBtn) prevBtn.disabled = currentCarouselIndex === 0;
            if (nextBtn) nextBtn.disabled = currentCarouselIndex >= maxIndex;
        }

        function refreshRoomsCarousel() {
            const roomsDiv = document.querySelector('.rooms-div');
            let container = roomsDiv.querySelector('.rooms-container');
            
            // If carousel not initialized yet, initialize it first
            if (!container) {
                initializeRoomsCarousel();
                container = roomsDiv.querySelector('.rooms-container');
            }
            
            if (!container) return;
            
            // Clear existing rooms
            container.innerHTML = '';
            
            // Sort rooms: sensors first, then alphabetically by name for unassigned
            const roomIds = Object.keys(roomData);
            const sortedRoomIds = roomIds.sort((a, b) => {
                const roomA = roomData[a];
                const roomB = roomData[b];
                
                // If both have sensors or both don't have sensors
                if (roomA.has_sensor === roomB.has_sensor) {
                    // Sort alphabetically by name
                    return roomA.name.toLowerCase().localeCompare(roomB.name.toLowerCase());
                }
                
                // Rooms with sensors come first
                return roomB.has_sensor ? 1 : -1;
            });
            
            sortedRoomIds.forEach((roomId) => {
                const room = roomData[roomId];
                const roomDiv = document.createElement('div');
                roomDiv.className = `room${roomId} rooms room`;
                roomDiv.setAttribute('data-room-id', roomId);
                roomDiv.onclick = function() { selectRoom(parseInt(roomId), this); };
                
                // Add visual indicator if room has sensor
                const sensorIndicator = room.has_sensor ? 
                    '<span style="color: #4CAF50; font-size: 0.8rem; margin-left: 5px;" title="Sensor assigned">●</span>' : '';
                
                roomDiv.innerHTML = `
                    <svg class="logo" viewBox="0 0 512 512" fill="white">
                        <path d="M256 32c-17.7 0-32 14.3-32 32V80C153.3 92.7 96 158.3 96 240v112l-32 32v16H448V384l-32-32V240c0-81.7-57.3-147.3-128-160V64c0-17.7-14.3-32-32-32zm0 448c35.3 0 64-28.7 64-64H192c0 35.3 28.7 64 64 64z"/>
                    </svg>
                    <div class="texts">
                        <h2 class="room-name">${room.name}${sensorIndicator}</h2>
                        <p onclick="renameRoom(this, event)">rename</p>
                    </div>
                `;
                
                container.appendChild(roomDiv);
            });
            
            // Reset to first position
            currentCarouselIndex = 0;
            updateCarousel();
        }

        // Initialize carousel after room data is loaded
        window.addEventListener('load', async function() {
            await fetchRoomData(); // This will now initialize carousel with all rooms
            await fetchRecentEmergency();
            await updateAllRoomStatusesFromHistory();
            connectWebSocket();
            
            const aside = document.querySelector('aside');
            const isDesktop = window.getComputedStyle(aside).display !== 'none';
            if (isDesktop) {
                const firstRoomId = Object.keys(roomData)[0];
                if (firstRoomId) {
                    const firstRoom = document.querySelector(`.room[data-room-id="${firstRoomId}"]`);
                    if (firstRoom) {
                        await selectRoom(parseInt(firstRoomId), firstRoom);
                    }
                }
            } else {
                currentSelectedRoom = Object.keys(roomData)[0] || 1;
            }
        });

        // Update the original createRoom function to refresh carousel
        const originalCreateRoom = createRoom;
        createRoom = async function() {
            await originalCreateRoom();
            refreshRoomsCarousel();
        };

        // Update the deleteRoom function to refresh carousel
        const originalDeleteRoom = deleteRoom;
        deleteRoom = async function(roomId, roomName) {
            await originalDeleteRoom(roomId, roomName);
            refreshRoomsCarousel();
        };


        // Shut the system down
        async function shutdownSystem(target) {
            const targetNames = {
                'all': 'All Systems'
            };
            
            const confirmMsg = `Are you sure you want to shutdown ${targetNames[target]}?\n\nThis will stop the SafeNSound monitoring system.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Double confirmation for safety
            const doubleConfirm = prompt(`Type "SHUTDOWN" to confirm shutting down ${targetNames[target]}:`);
            
            if (doubleConfirm !== "SHUTDOWN") {
                alert("Shutdown cancelled.");
                return;
            }
            try {
                const response = await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        target: 'all',
                        confirm: true
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    
                    if (target === 'all') {
                        document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><h1>System Shutting Down...</h1></div>';
                    }
                } else {
                    const error = await response.json();
                    alert(`Shutdown failed: ${error.detail}`);
                }
            } catch (error) {
                console.error('Shutdown error:', error);
                alert('Failed to send shutdown command.');
            }
        }

    </script>
</body>
</html>